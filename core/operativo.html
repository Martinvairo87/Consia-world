<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CONSIA · Operativo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    body{margin:0;background:#020617;color:#fff;min-height:100vh;padding:18px}
    .wrap{max-width:880px;margin:0 auto}
    .card{background:rgba(15,23,42,.86);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px;margin:12px 0}
    h1{margin:0 0 10px;font-size:18px}
    input,textarea,button{
      width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:#0b1220;color:#fff;outline:none
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    button{cursor:pointer;background:#111827;font-weight:700}
    .ok{color:#22c55e} .bad{color:#ef4444} .muted{opacity:.75;font-size:12px}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,.08)}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>CONSIA · Operativo (Owner-Only)</h1>
    <div class="muted">Si el sistema está bien, aquí “Ping” devuelve pong.</div>
  </div>

  <div class="card">
    <h1>1) Owner Key</h1>
    <input id="owner" placeholder="Pegá tu OWNER_KEY (se guarda solo en esta sesión)" />
    <div class="row" style="margin-top:10px">
      <button id="saveOwner">Guardar</button>
      <button id="clearOwner">Borrar</button>
    </div>
    <div class="muted" id="ownerState" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h1>2) Ping / Health</h1>
    <div class="row">
      <button id="health">Health</button>
      <button id="ping">Ping (Owner)</button>
      <button id="config">Config</button>
    </div>
    <pre id="out">Listo.</pre>
  </div>

</div>

<script>
  const out = document.getElementById('out');
  const ownerInput = document.getElementById('owner');
  const ownerState = document.getElementById('ownerState');

  function setOut(x){ out.textContent = typeof x === 'string' ? x : JSON.stringify(x,null,2); }

  function getOwner(){
    return sessionStorage.getItem('CONSIA_OWNER') || '';
  }
  function setOwner(v){
    sessionStorage.setItem('CONSIA_OWNER', v);
    ownerState.textContent = v ? 'Owner cargado ✅' : 'Owner vacío ⚠️';
  }

  ownerInput.value = getOwner();
  setOwner(ownerInput.value);

  document.getElementById('saveOwner').onclick = ()=>{
    setOwner(ownerInput.value.trim());
    setOut('Owner guardado en sesión.');
  };
  document.getElementById('clearOwner').onclick = ()=>{
    ownerInput.value = '';
    setOwner('');
    setOut('Owner borrado.');
  };

  async function call(path, owner=false){
    const headers = {};
    if(owner){
      const ok = getOwner();
      if(!ok) throw new Error('Falta OWNER_KEY');
      headers['x-consia-owner'] = ok;
    }
    const r = await fetch('/api' + path, { headers, cache:'no-store' });
    const txt = await r.text();
    let data; try{ data = JSON.parse(txt);}catch{ data = txt; }
    if(!r.ok) throw new Error('HTTP '+r.status+' · '+txt);
    return data;
  }

  document.getElementById('health').onclick = async ()=>{
    try{ setOut(await call('/health')); } catch(e){ setOut('ERROR: '+e.message); }
  };
  document.getElementById('config').onclick = async ()=>{
    try{ setOut(await call('/config')); } catch(e){ setOut('ERROR: '+e.message); }
  };
  document.getElementById('ping').onclick = async ()=>{
    try{ setOut(await call('/ping', true)); } catch(e){ setOut('ERROR: '+e.message); }
  };
</script>
</body>
</html>
