<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CONSIA</title>
  <style>
    :root{
      --bg:#05060a;
      --fg:#e9ecff;
      --mut:rgba(233,236,255,.70);
      --glass:rgba(255,255,255,.06);
      --bd:rgba(255,255,255,.12);
      --acc:#7c5cff;
      --shadow:0 22px 70px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
    #app{height:100%;display:flex;flex-direction:column}
    header{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px 12px;
      background:linear-gradient(180deg, rgba(5,6,10,.92), rgba(5,6,10,.55));
      border-bottom:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(14px);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.6px}
    .dot{width:10px;height:10px;border-radius:99px;background:var(--acc);box-shadow:0 0 26px rgba(124,92,255,.9)}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--bd);
      background:rgba(255,255,255,.04);
      color:var(--mut);
      font-size:12px;font-weight:800;
      user-select:none;cursor:pointer;
    }
    .tab.on{border-color:rgba(124,92,255,.45);background:rgba(124,92,255,.18);color:rgba(233,236,255,.92)}
    main{flex:1;display:grid;place-items:center;padding:14px}
    .stage{
      width:min(980px, 96vw);
      aspect-ratio:16/9;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:#000;
      box-shadow:var(--shadow);
      position:relative;
    }
    @media (max-width: 980px){ .stage{aspect-ratio:9/16; width:min(520px, 96vw);} }
    video{display:none}
    canvas{position:absolute;inset:0;width:100%;height:100%}
    .overlay{
      position:absolute;inset:0;
      display:flex;flex-direction:column;justify-content:flex-end;
      padding:14px;
      background:linear-gradient(180deg, rgba(0,0,0,0) 55%, rgba(0,0,0,.52));
      pointer-events:none;
    }
    .controls{
      pointer-events:auto;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:12px;border-radius:18px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
    }
    .left,.right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      appearance:none;cursor:pointer;user-select:none;
      padding:12px 14px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--fg);font-weight:900;
      transition:.15s transform,.15s background,.15s border;
      letter-spacing:.2px;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.20)}
    .btn.primary{background:rgba(124,92,255,.22);border-color:rgba(124,92,255,.45)}
    .btn.primary:hover{background:rgba(124,92,255,.30)}
    .btn.ghost{background:transparent}
    .small{font-size:12px;font-weight:800;color:var(--mut)}
    .pill{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:var(--mut);font-size:12px}
    .toast{
      position:fixed;left:14px;right:14px;bottom:14px;
      padding:12px 14px;border-radius:16px;
      background:rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(14px);
      display:none;z-index:20;
      box-shadow:var(--shadow);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }
    .toast.show{display:block}
    footer{
      padding:10px 14px 14px;
      color:rgba(233,236,255,.55);
      font-size:12px;
      text-align:center;
    }
    a{color:rgba(233,236,255,.70);text-decoration:none}
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand"><span class="dot"></span> CONSIA</div>
    <div class="tabs" role="tablist" aria-label="modes">
      <div class="tab on" id="tabSolo">SOLO</div>
      <div class="tab" id="tabDuo">DÚO</div>
      <div class="tab" id="tabMoment">MOMENTO</div>
    </div>
  </header>

  <main>
    <div class="stage" aria-label="consia live stage">
      <video id="cam" playsinline muted autoplay></video>
      <canvas id="out"></canvas>

      <div class="overlay">
        <div class="controls">
          <div class="left">
            <button class="btn primary" id="btnEnter">Entrar a LIVE</button>
            <button class="btn ghost" id="btnStop">Salir</button>
            <span class="pill" id="status">Listo</span>
          </div>
          <div class="right">
            <button class="btn" id="scene1">Escena</button>
            <button class="btn" id="scene2">Noche</button>
            <button class="btn" id="scene3">Naturaleza</button>
            <button class="btn" id="btnInvite" style="display:none">Invitar</button>
            <span class="pill" id="timer" style="display:none">03:00</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    LIVE es efímero: sin historial, sin exportaciones.
  </footer>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
<script>
  const $ = (id)=>document.getElementById(id);

  const cam = $("cam");
  const out = $("out");
  const ctx = out.getContext("2d");
  const toastEl = $("toast");
  const statusEl = $("status");
  const timerEl = $("timer");

  const tabSolo = $("tabSolo");
  const tabDuo = $("tabDuo");
  const tabMoment = $("tabMoment");

  const btnEnter = $("btnEnter");
  const btnStop = $("btnStop");
  const btnInvite = $("btnInvite");

  const toast = (m)=>{ toastEl.textContent=m; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"), 1700); };
  const setStatus = (m)=> statusEl.textContent = m;

  // Scenes (puedes reemplazar por tus escenas premium luego)
  const SCENES = [
    "https://images.unsplash.com/photo-1500375592092-40eb2168fd21?auto=format&fit=crop&w=1600&q=70",
    "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1600&q=70",
    "https://images.unsplash.com/photo-1520975661595-6453be3f7070?auto=format&fit=crop&w=1600&q=70"
  ];
  let bgImg = new Image(), bgReady=false;
  function setBg(url){
    bgReady=false;
    bgImg = new Image();
    bgImg.crossOrigin = "anonymous";
    bgImg.onload=()=>{ bgReady=true; toast("Escena aplicada"); };
    bgImg.onerror=()=>toast("No pude cargar escena");
    bgImg.src=url;
  }
  setBg(SCENES[0]);

  // Resize
  function resize(){
    const r = out.getBoundingClientRect();
    out.width = Math.floor(r.width * devicePixelRatio);
    out.height= Math.floor(r.height* devicePixelRatio);
  }
  addEventListener("resize", resize);

  function drawCover(img){
    const cw=out.width, ch=out.height;
    const iw=img.width, ih=img.height;
    const s=Math.max(cw/iw, ch/ih);
    const nw=iw*s, nh=ih*s;
    ctx.drawImage(img, (cw-nw)/2, (ch-nh)/2, nw, nh);
  }

  // MediaPipe segmentation (on-device)
  const seg = new SelfieSegmentation({
    locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
  });
  seg.setOptions({ modelSelection: 1 });
  seg.onResults(onResults);

  let stream=null, running=false;

  function onResults(res){
    if(!running) return;
    ctx.clearRect(0,0,out.width,out.height);
    if(bgReady) drawCover(bgImg); else { ctx.fillStyle="#000"; ctx.fillRect(0,0,out.width,out.height); }

    ctx.save();
    ctx.globalCompositeOperation="destination-in";
    ctx.drawImage(res.segmentationMask, 0, 0, out.width, out.height);
    ctx.restore();

    ctx.save();
    ctx.globalCompositeOperation="destination-over";
    ctx.drawImage(res.image, 0, 0, out.width, out.height);
    ctx.restore();
  }

  async function startLive(){
    if(stream) return;
    resize();
    setStatus("Conectando…");
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }, audio:false });
      cam.srcObject = stream;
      await cam.play();
      running=true;
      setStatus("LIVE");
      const loop = async ()=>{
        if(!running) return;
        await seg.send({ image: cam });
        requestAnimationFrame(loop);
      };
      loop();
      toast("LIVE activo");
    } catch(e){
      setStatus("Bloqueado");
      toast("Permiso de cámara requerido");
    }
  }

  function stopLive(){
    running=false;
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream=null;
    ctx.clearRect(0,0,out.width,out.height);
    setStatus("Listo");
    timerEl.style.display="none";
    toast("Sesión cerrada");
  }

  // Modes
  let mode="solo";
  function setMode(m){
    mode=m;
    tabSolo.classList.toggle("on", m==="solo");
    tabDuo.classList.toggle("on", m==="duo");
    tabMoment.classList.toggle("on", m==="moment");
    btnInvite.style.display = (m==="duo") ? "inline-block" : "none";
    timerEl.style.display = (m==="moment") ? "inline-block" : "none";
    if(m==="moment") timerEl.textContent="03:00";
  }
  tabSolo.onclick = ()=>setMode("solo");
  tabDuo.onclick = ()=>setMode("duo");
  tabMoment.onclick = ()=>setMode("moment");

  // Moment timer (3 minutes)
  let momentT=null, left=0;
  function startMoment(){
    if(!running){ toast("Entrá a LIVE primero"); return; }
    if(mode!=="moment"){ setMode("moment"); }
    if(momentT) return;
    left=180; timerEl.textContent="03:00";
    toast("Momento: 3 minutos");
    momentT=setInterval(()=>{
      left--;
      const m=String(Math.floor(left/60)).padStart(2,"0");
      const s=String(left%60).padStart(2,"0");
      timerEl.textContent=`${m}:${s}`;
      if(left===120) setBg(SCENES[1]);
      if(left===60)  setBg(SCENES[2]);
      if(left<=0){
        clearInterval(momentT); momentT=null;
        stopLive();
      }
    },1000);
  }

  // Duo invite (backend call)
  // IMPORTANTE: acá NO hardcodeamos API_KEY. Para usuario final luego usamos tokens efímeros.
  // Para probar hoy: si querés, poné tu API_KEY en localStorage desde consola (Owner), no visible en UI.
  async function createInvite(){
    const key = localStorage.getItem("CONSIA_OWNER_API_KEY");
    if(!key){ toast("Owner key no configurada"); return; }
    const res = await fetch("https://api.consia.world/invite/create", {
      method:"POST",
      headers:{ "Authorization": "Bearer " + key }
    });
    const data = await res.json();
    if(!data.ok){ toast("No pude crear invite"); return; }
    const link = location.origin + "/?invite=" + encodeURIComponent(data.invite);
    try{ await navigator.clipboard.writeText(link); toast("Invite copiado"); }
    catch{ toast("Invite: " + data.invite); }
  }

  // Scenes
  $("scene1").onclick = ()=>setBg(SCENES[0]);
  $("scene2").onclick = ()=>setBg(SCENES[1]);
  $("scene3").onclick = ()=>setBg(SCENES[2]);

  // Buttons
  btnEnter.onclick = async ()=>{
    await startLive();
    if(mode==="moment") startMoment();
  };
  btnStop.onclick = stopLive;
  btnInvite.onclick = createInvite;

  // Autostart moment if selected
  tabMoment.onclick = ()=>{ setMode("moment"); };

  // Privacy: if tab hidden, close session (web-best-effort)
  document.addEventListener("visibilitychange", ()=>{ if(document.hidden) stopLive(); });

  // Default
  setMode("solo");
</script>
</body>
</html>
