<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CONSIA</title>
  <style>
    :root{--bg:#0b0d12;--card:#121626;--txt:#e9eefc;--mut:#9aa6c7;--acc:#6aa7ff;--ok:#5dffb1;--bad:#ff6a6a}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:rgba(11,13,18,.9);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08);z-index:20}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.06em}
    .dot{width:10px;height:10px;border-radius:99px;background:var(--ok);box-shadow:0 0 20px rgba(93,255,177,.6)}
    nav{display:flex;gap:10px;flex-wrap:wrap}
    button, input, textarea, select{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--txt);padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(135deg,rgba(106,167,255,.25),rgba(106,167,255,.05));border-color:rgba(106,167,255,.35)}
    button.good{background:linear-gradient(135deg,rgba(93,255,177,.20),rgba(93,255,177,.05));border-color:rgba(93,255,177,.35)}
    button.bad{background:linear-gradient(135deg,rgba(255,106,106,.20),rgba(255,106,106,.05));border-color:rgba(255,106,106,.35)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px}
    .title{font-weight:800;margin:0 0 10px 0}
    .mut{color:var(--mut)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    textarea{width:100%;min-height:120px;resize:vertical}
    .out{white-space:pre-wrap;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;min-height:120px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03)}
    .tab.active{border-color:rgba(106,167,255,.45);box-shadow:0 0 0 1px rgba(106,167,255,.12) inset}
    .hide{display:none}
    .prod{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media (max-width: 620px){.prod{grid-template-columns:1fr}}
    .prod .p{border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;background:rgba(255,255,255,.03)}
    .p b{display:block;margin-bottom:6px}
    .small{font-size:12px}
    video{width:100%;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:#000}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="brand"><span class="dot"></span> CONSIA <span class="pill mono" id="pillApi">API: ...</span></div>
      <nav>
        <button class="tab active" data-tab="chat">Chat</button>
        <button class="tab" data-tab="voice">Voice / Avatar</button>
        <button class="tab" data-tab="owner">Owner Dashboard</button>
        <button class="tab" data-tab="market">Marketplace</button>
        <button class="tab" data-tab="plans">Planes</button>
        <a href="/voice.html" style="text-decoration:none"><button class="primary">Abrir voice.html</button></a>
      </nav>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <!-- CHAT -->
      <section id="chat" class="panel">
        <h2 class="title">CONSIA Chat</h2>
        <div class="row">
          <span class="pill">Sesi√≥n: <span class="mono" id="sessionId"></span></span>
          <span class="pill">Plan: <span class="mono" id="planId">FREE</span></span>
          <span class="pill">Estado: <span class="mono" id="statusId">...</span></span>
        </div>
        <div style="height:10px"></div>
        <textarea id="msg" placeholder="Escrib√≠ un comando..."></textarea>
        <div class="row" style="margin-top:10px">
          <button class="primary" id="send">Enviar</button>
          <button id="clear">Limpiar</button>
        </div>
        <div style="height:10px"></div>
        <div class="out mono" id="out"></div>
      </section>

      <!-- VOICE -->
      <section id="voice" class="panel hide">
        <h2 class="title">Voice / Avatar</h2>
        <p class="mut">Voice local (iOS/Browser): dictado + lectura. Avatar desde API.</p>
        <div class="row">
          <button class="good" id="startRec">üéôÔ∏è Dictar</button>
          <button id="stopRec">‚èπÔ∏è Stop</button>
          <button class="primary" id="speak">üîä Leer respuesta</button>
        </div>
        <div style="height:10px"></div>
        <textarea id="voiceText" placeholder="Tu voz aparecer√° ac√°..."></textarea>
        <div style="height:10px"></div>
        <video id="avatar" controls playsinline></video>
        <div class="row" style="margin-top:10px">
          <button id="reloadAvatar">Recargar avatar</button>
        </div>
      </section>

      <!-- OWNER -->
      <section id="owner" class="panel hide">
        <h2 class="title">Owner Dashboard (Owner-Only)</h2>
        <p class="mut">Token se guarda solo en sessionStorage (no queda persistente).</p>
        <div class="row">
          <input id="ownerToken" placeholder="OWNER_TOKEN" style="flex:1;min-width:260px" />
          <button class="primary" id="ownerSave">Guardar</button>
          <button class="bad" id="ownerClear">Borrar</button>
        </div>

        <div style="height:12px"></div>
        <div class="row">
          <button class="good" id="ownerPing">Owner Ping</button>
          <button class="primary" id="ownerStats">Stats</button>
        </div>

        <div style="height:12px"></div>
        <div class="out mono" id="ownerOut"></div>

        <div style="height:14px"></div>
        <h3 class="title" style="font-size:16px">Avatar upload (mp4)</h3>
        <div class="row">
          <input type="file" id="avatarFile" accept="video/mp4,video/quicktime,video/*" />
          <button class="primary" id="uploadAvatar">Subir</button>
        </div>
      </section>

      <!-- MARKET -->
      <section id="market" class="panel hide">
        <h2 class="title">Marketplace / Dropshipping</h2>
        <p class="mut">Cat√°logo desde API. Checkout intent (stub) listo para conectar Paddle/Stripe.</p>
        <div class="row">
          <button class="primary" id="loadCatalog">Cargar cat√°logo</button>
        </div>
        <div style="height:12px"></div>
        <div class="prod" id="catalog"></div>
        <div style="height:12px"></div>
        <div class="out mono" id="marketOut"></div>
      </section>

      <!-- PLANS -->
      <section id="plans" class="panel hide">
        <h2 class="title">Planes</h2>
        <p class="mut">El plan vive por sesi√≥n. Owner puede setear plan para tu sessionId.</p>

        <div class="row">
          <select id="planPick">
            <option>FREE</option>
            <option>PRO</option>
            <option>BUSINESS</option>
            <option>ENTERPRISE</option>
          </select>
          <button class="primary" id="setPlan">Owner Set Plan (requiere token)</button>
          <button id="getPlan">Ver plan actual</button>
        </div>

        <div style="height:10px"></div>
        <div class="out mono" id="planOut"></div>
      </section>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2 class="title">CONSIA Control</h2>
      <p class="mut">Backend: <span class="mono" id="apiUrlText"></span></p>
      <div class="row">
        <button class="primary" id="checkHealth">Health</button>
        <button id="openApi">Abrir API</button>
      </div>
      <div style="height:10px"></div>
      <div class="out mono" id="sys"></div>

      <div style="height:14px"></div>
      <h3 class="title" style="font-size:16px">Realtime Room (WS)</h3>
      <div class="row">
        <input id="room" placeholder="room (ej: main)" value="main" style="flex:1;min-width:180px" />
        <button class="primary" id="wsConnect">Conectar</button>
        <button id="wsClose">Cerrar</button>
      </div>
      <div style="height:10px"></div>
      <input id="wsMsg" placeholder="mensaje..." style="width:100%" />
      <div class="row" style="margin-top:10px">
        <button class="good" id="wsSend">Enviar</button>
      </div>
      <div style="height:10px"></div>
      <div class="out mono" id="wsOut"></div>

      <div style="height:14px"></div>
      <p class="small mut">Owner-Only: acciones sensibles exigen header <span class="mono">x-owner-token</span>.</p>
    </div>
  </div>
</main>

<script>
  const API = "https://api.consia.world";
  const pillApi = document.getElementById("pillApi");
  const apiUrlText = document.getElementById("apiUrlText");
  apiUrlText.textContent = API;

  // session
  const sessionKey = "consia_session_id";
  let sessionId = localStorage.getItem(sessionKey);
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    localStorage.setItem(sessionKey, sessionId);
  }
  document.getElementById("sessionId").textContent = sessionId;

  // owner token (session only)
  const ownerKey = "CONSIA_OWNER_TOKEN";
  const ownerTokenInput = document.getElementById("ownerToken");
  ownerTokenInput.value = sessionStorage.getItem(ownerKey) || "";

  function ownerToken() {
    return (sessionStorage.getItem(ownerKey) || "").trim();
  }

  function headers(extra={}) {
    return {
      "content-type":"application/json",
      "x-consia-session": sessionId,
      "x-consia-device":"web",
      ...extra,
    };
  }

  async function apiGet(path, extraHeaders={}) {
    const r = await fetch(API+path, { headers: headers(extraHeaders) });
    return { status:r.status, json: await r.json().catch(()=>null) };
  }
  async function apiPost(path, body, extraHeaders={}) {
    const r = await fetch(API+path, { method:"POST", headers: headers(extraHeaders), body: JSON.stringify(body||{}) });
    return { status:r.status, json: await r.json().catch(()=>null) };
  }

  // Tabs
  const tabs = document.querySelectorAll(".tab[data-tab]");
  const panels = document.querySelectorAll(".panel");
  tabs.forEach(t=>{
    t.addEventListener("click", ()=>{
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      panels.forEach(p=>p.classList.add("hide"));
      document.getElementById(t.dataset.tab).classList.remove("hide");
    });
  });

  // Health
  const sys = document.getElementById("sys");
  const statusId = document.getElementById("statusId");
  async function refreshHealth(){
    const {status, json} = await apiGet("/health");
    pillApi.textContent = "API: " + (status===200 ? "OK" : "DOWN");
    statusId.textContent = status===200 ? "healthy" : "error";
    sys.textContent = JSON.stringify({status, ...json}, null, 2);
  }
  document.getElementById("checkHealth").onclick = refreshHealth;
  document.getElementById("openApi").onclick = ()=> window.open(API+"/health","_blank");
  refreshHealth();

  // Chat
  const out = document.getElementById("out");
  document.getElementById("send").onclick = async ()=>{
    const msg = document.getElementById("msg").value.trim();
    if(!msg) return;
    out.textContent = "CONSIA‚Ä¶";
    const {status, json} = await apiPost("/ask", {message:msg});
    out.textContent = JSON.stringify({status, ...json}, null, 2);
    if(json && json.plan) document.getElementById("planId").textContent = json.plan;
  };
  document.getElementById("clear").onclick = ()=> { document.getElementById("msg").value=""; out.textContent=""; };

  // Voice (Web Speech)
  let recog=null;
  function setupSpeech(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return null;
    const r = new SR();
    r.lang = "es-AR";
    r.interimResults = true;
    r.continuous = true;
    return r;
  }
  const voiceText = document.getElementById("voiceText");
  document.getElementById("startRec").onclick = ()=>{
    if(!recog) recog = setupSpeech();
    if(!recog){ alert("SpeechRecognition no disponible en este navegador."); return; }
    recog.onresult = (e)=>{
      let txt="";
      for(let i=e.resultIndex;i<e.results.length;i++){
        txt += e.results[i][0].transcript;
      }
      voiceText.value = txt;
    };
    recog.start();
  };
  document.getElementById("stopRec").onclick = ()=>{ try{ recog && recog.stop(); }catch{} };
  document.getElementById("speak").onclick = ()=>{
    const t = out.textContent || "CONSIA";
    const u = new SpeechSynthesisUtterance(t.slice(0,1200));
    u.lang="es-AR";
    speechSynthesis.speak(u);
  };

  // Avatar
  const avatar = document.getElementById("avatar");
  function loadAvatar(){
    avatar.src = API + "/avatar.mp4?ts=" + Date.now();
  }
  document.getElementById("reloadAvatar").onclick = loadAvatar;
  loadAvatar();

  // Owner controls
  const ownerOut = document.getElementById("ownerOut");
  document.getElementById("ownerSave").onclick = ()=>{
    sessionStorage.setItem(ownerKey, ownerTokenInput.value.trim());
    ownerOut.textContent = "Owner token guardado en sessionStorage.";
  };
  document.getElementById("ownerClear").onclick = ()=>{
    sessionStorage.removeItem(ownerKey);
    ownerTokenInput.value="";
    ownerOut.textContent = "Owner token borrado.";
  };
  document.getElementById("ownerPing").onclick = async ()=>{
    const tok = ownerToken();
    const {status, json} = await apiPost("/owner/ping", {}, tok? {"x-owner-token": tok}: {});
    ownerOut.textContent = JSON.stringify({status, ...json}, null, 2);
  };
  document.getElementById("ownerStats").onclick = async ()=>{
    const tok = ownerToken();
    const r = await fetch(API+"/owner/stats", { headers: headers(tok? {"x-owner-token": tok}: {}) });
    const json = await r.json().catch(()=>null);
    ownerOut.textContent = JSON.stringify({status:r.status, ...json}, null, 2);
  };

  // Avatar upload (owner)
  document.getElementById("uploadAvatar").onclick = async ()=>{
    const tok = ownerToken();
    if(!tok){ alert("Peg√° OWNER_TOKEN primero."); return; }
    const f = document.getElementById("avatarFile").files[0];
    if(!f){ alert("Eleg√≠ un archivo."); return; }
    ownerOut.textContent="Subiendo avatar‚Ä¶";
    const r = await fetch(API+"/owner/avatar/upload", {
      method:"POST",
      headers: {
        "x-owner-token": tok,
        "x-consia-session": sessionId,
        "x-consia-device":"web",
        "content-type": f.type || "application/octet-stream",
      },
      body: await f.arrayBuffer()
    });
    const json = await r.json().catch(()=>null);
    ownerOut.textContent = JSON.stringify({status:r.status, ...json}, null, 2);
    loadAvatar();
  };

  // Marketplace
  const catalogEl = document.getElementById("catalog");
  const marketOut = document.getElementById("marketOut");
  document.getElementById("loadCatalog").onclick = async ()=>{
    marketOut.textContent="Cargando‚Ä¶";
    const {status, json} = await apiGet("/market/catalog");
    marketOut.textContent = JSON.stringify({status, ...json}, null, 2);
    const items = (json?.catalog?.products||[]);
    catalogEl.innerHTML = "";
    items.forEach(p=>{
      const d = document.createElement("div");
      d.className="p";
      d.innerHTML = `
        <b>${p.name}</b>
        <div class="mut small">${p.tagline||""}</div>
        <div style="height:8px"></div>
        <div class="row" style="justify-content:space-between">
          <span class="pill mono">$${p.price_usd}</span>
          <button class="primary">Comprar</button>
        </div>
        <div class="mut small" style="margin-top:8px">SKU: <span class="mono">${p.sku}</span> ‚Ä¢ ${p.category} ${p.dropship? "‚Ä¢ Dropship":""}</div>
      `;
      d.querySelector("button").onclick = async ()=>{
        marketOut.textContent="Creando checkout intent‚Ä¶";
        const {status, json} = await apiPost("/market/checkout", {sku:p.sku, qty:1});
        marketOut.textContent = JSON.stringify({status, ...json}, null, 2);
      };
      catalogEl.appendChild(d);
    });
  };

  // Plans
  const planOut = document.getElementById("planOut");
  document.getElementById("setPlan").onclick = async ()=>{
    const tok = ownerToken();
    if(!tok){ alert("Peg√° OWNER_TOKEN primero."); return; }
    const plan = document.getElementById("planPick").value;
    planOut.textContent="Seteando plan‚Ä¶";
    const {status, json} = await apiPost("/owner/plan/set", {session:sessionId, plan}, {"x-owner-token": tok});
    planOut.textContent = JSON.stringify({status, ...json}, null, 2);
    if(json?.plan) document.getElementById("planId").textContent = json.plan;
  };
  document.getElementById("getPlan").onclick = async ()=>{
    planOut.textContent="Consultando‚Ä¶";
    const r = await fetch(API+"/owner/plan/get?session="+encodeURIComponent(sessionId), { headers: headers(ownerToken()? {"x-owner-token": ownerToken()}: {}) });
    const json = await r.json().catch(()=>null);
    planOut.textContent = JSON.stringify({status:r.status, ...json}, null, 2);
    if(json?.plan) document.getElementById("planId").textContent = json.plan;
  };

  // WS Rooms
  let ws=null;
  const wsOut=document.getElementById("wsOut");
  function logWS(x){ wsOut.textContent += x + "\n"; wsOut.scrollTop=wsOut.scrollHeight; }
  document.getElementById("wsConnect").onclick = ()=>{
    const room = document.getElementById("room").value.trim() || "main";
    const wsUrl = API.replace("https://","wss://") + "/ws/" + encodeURIComponent(room);
    wsOut.textContent="";
    ws = new WebSocket(wsUrl);
    ws.onopen = ()=> logWS("WS: connected " + wsUrl);
    ws.onmessage = (e)=> logWS("MSG: " + e.data);
    ws.onclose = ()=> logWS("WS: closed");
    ws.onerror = ()=> logWS("WS: error");
  };
  document.getElementById("wsClose").onclick = ()=>{ try{ ws && ws.close(); }catch{} };
  document.getElementById("wsSend").onclick = ()=>{
    const t = document.getElementById("wsMsg").value.trim();
    if(!t || !ws) return;
    ws.send(t);
    document.getElementById("wsMsg").value="";
  };
</script>
</body>
</html>
