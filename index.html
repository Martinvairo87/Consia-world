<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CONSIA</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b0b10;color:#fff}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    .card{background:#141422;border:1px solid #2a2a3d;border-radius:14px;padding:16px;margin:12px 0}
    input,textarea,button{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid #2a2a3d;background:#0f0f19;color:#fff;padding:12px}
    button{cursor:pointer;font-weight:700}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mono{font-family:ui-monospace,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap}
    .ok{color:#6dff9a} .bad{color:#ff6d6d}
    @media (max-width:820px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CONSIA</h1>
    <div class="card">
      <div class="row">
        <div>
          <label>API Base</label>
          <input id="apiBase" value="https://api.consia.world" />
        </div>
        <div>
          <label>Owner Token (opcional, solo para /owner/ping)</label>
          <input id="ownerToken" placeholder="(no se guarda)" />
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button id="btnHealth">Test /health</button>
        <button id="btnPing">Test /ping</button>
        <button id="btnOwner">Test /owner/ping</button>
        <button id="btnMeetPing">Test /meet/ping</button>
      </div>
      <div id="status" class="mono" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h3>Chat (POST /ask)</h3>
      <textarea id="msg" rows="4" placeholder="Escribí acá..."></textarea>
      <button id="btnAsk" style="margin-top:10px">Enviar</button>
      <div id="askOut" class="mono" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h3>WebSocket Simple (GET /ws)</h3>
      <button id="btnWs">Conectar /ws</button>
      <input id="wsMsg" placeholder="mensaje para enviar por WS" style="margin-top:10px" />
      <button id="btnWsSend" style="margin-top:10px">Enviar WS</button>
      <div id="wsOut" class="mono" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h3>Meet Room Realtime (DO) — /meet/ws/:room</h3>
      <input id="room" value="global" />
      <button id="btnRoom">Conectar Room</button>
      <input id="roomMsg" placeholder="mensaje para enviar al room" style="margin-top:10px" />
      <button id="btnRoomSend" style="margin-top:10px">Enviar Room</button>
      <div id="roomOut" class="mono" style="margin-top:10px"></div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  function api() { return ($("apiBase").value || "").replace(/\/+$/,""); }
  function ownerHeaders() {
    const t = ($("ownerToken").value || "").trim();
    return t ? { "x-owner-token": t } : {};
  }
  function show(el, obj) { el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj,null,2); }

  async function getJson(path, headers={}) {
    const res = await fetch(api()+path, { headers });
    const data = await res.json().catch(()=>({ok:false,error:"bad_json"}));
    return { status: res.status, data };
  }

  $("btnHealth").onclick = async () => show($("status"), await getJson("/health"));
  $("btnPing").onclick = async () => show($("status"), await getJson("/ping"));
  $("btnOwner").onclick = async () => show($("status"), await getJson("/owner/ping", ownerHeaders()));
  $("btnMeetPing").onclick = async () => show($("status"), await getJson("/meet/ping"));

  $("btnAsk").onclick = async () => {
    const message = $("msg").value || "";
    const res = await fetch(api()+"/ask", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ message })
    });
    const data = await res.json().catch(()=>({ok:false,error:"bad_json"}));
    show($("askOut"), { status: res.status, data });
  };

  // WS simple
  let ws = null;
  $("btnWs").onclick = () => {
    if (ws && ws.readyState === 1) { ws.close(); ws=null; }
    const u = api().replace("https://","wss://").replace("http://","ws://") + "/ws";
    ws = new WebSocket(u);
    ws.onopen = () => show($("wsOut"), "WS conectado: "+u);
    ws.onmessage = (e) => $("wsOut").textContent += "\n" + e.data;
    ws.onclose = () => $("wsOut").textContent += "\n[closed]";
    ws.onerror = () => $("wsOut").textContent += "\n[error]";
  };
  $("btnWsSend").onclick = () => {
    if (!ws || ws.readyState !== 1) return;
    ws.send($("wsMsg").value || "");
  };

  // Room WS (DO)
  let rws = null;
  $("btnRoom").onclick = () => {
    if (rws && rws.readyState === 1) { rws.close(); rws=null; }
    const room = ($("room").value || "global").trim();
    const u = api().replace("https://","wss://").replace("http://","ws://") + "/meet/ws/" + encodeURIComponent(room);
    rws = new WebSocket(u);
    rws.onopen = () => show($("roomOut"), "ROOM conectado: "+u);
    rws.onmessage = (e) => $("roomOut").textContent += "\n" + e.data;
    rws.onclose = () => $("roomOut").textContent += "\n[closed]";
    rws.onerror = () => $("roomOut").textContent += "\n[error]";
  };
  $("btnRoomSend").onclick = () => {
    if (!rws || rws.readyState !== 1) return;
    rws.send($("roomMsg").value || "");
  };
</script>
</body>
</html>
