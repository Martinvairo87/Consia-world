<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>CONSIA LIVE</title>

<style>
:root{
  --bg:#000;
  --glass:rgba(10,10,10,.78);
  --line:rgba(255,255,255,.14);
  --text:#fff;
  --muted:rgba(255,255,255,.75);
  --muted2:rgba(255,255,255,.55);
  --good:#3ddc84;
  --warn:#ffcc00;
  --bad:#ff4d4d;
  --shadow:0 18px 44px rgba(0,0,0,.55);
  --r:16px;
  --r2:22px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
  overflow:hidden;
}
#topbar{
  position:fixed; inset:0 0 auto 0; height:64px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 14px;
  background:linear-gradient(180deg, rgba(0,0,0,.9), rgba(0,0,0,.35));
  border-bottom:1px solid rgba(255,255,255,.08);
  backdrop-filter: blur(10px);
  z-index:50;
}
#brand{display:flex; flex-direction:column}
#brand .t{font-weight:800; letter-spacing:.4px}
#brand .s{font-size:12px; color:var(--muted)}
#status{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.pill{
  display:inline-flex; gap:8px; align-items:center;
  padding:8px 10px; border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  font-size:12px; color:var(--muted);
}
.dot{width:8px;height:8px;border-radius:50%}
.good{background:var(--good)}
.warn{background:var(--warn)}
.bad{background:var(--bad)}

#stage{position:absolute; inset:64px 0 0 0}
#remoteVideo{width:100%; height:100%; object-fit:cover; background:#000}

#overlay{
  position:absolute; inset:64px 0 0 0;
  display:flex; align-items:center; justify-content:center;
  padding:22px; pointer-events:none; z-index:10;
}
#overlayCard{
  width:min(520px,92vw);
  background:var(--glass);
  border:1px solid var(--line);
  border-radius:var(--r2);
  padding:18px;
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
}
#overlayCard h3{margin:0 0 6px 0}
#overlayCard p{margin:0; font-size:13px; color:var(--muted); line-height:1.35}
#overlayBadge{
  margin-top:12px; display:inline-flex; gap:8px; align-items:center;
  padding:8px 10px; border-radius:999px;
  background:rgba(255,255,255,.06); border:1px solid var(--line);
  font-size:12px; color:var(--muted);
}

#pip{
  position:absolute; right:16px; bottom:16px;
  width:160px; height:220px;
  border-radius:var(--r);
  background:#111; border:1px solid var(--line);
  box-shadow:0 12px 30px rgba(0,0,0,.6);
  overflow:hidden; z-index:20;
}
#localVideo{
  width:100%; height:100%; object-fit:cover;
  transform:scaleX(-1); background:#0a0a0a;
}
#pipBadges{
  position:absolute; left:10px; bottom:10px;
  display:flex; gap:8px; align-items:center;
  padding:6px 8px; border-radius:999px;
  background:rgba(0,0,0,.55); border:1px solid var(--line);
  font-size:12px;
}

#controls{
  position:fixed; left:12px; right:12px; bottom:12px;
  display:flex; gap:8px; flex-wrap:wrap; justify-content:center; z-index:60;
}
.btn{
  border:none; cursor:pointer; border-radius:999px;
  padding:12px 14px; font-weight:800; font-size:13px; color:#fff;
  background:rgba(255,255,255,.08); border:1px solid var(--line);
  backdrop-filter: blur(10px);
}
.btn.primary{background:rgba(61,220,132,.16); border-color:rgba(61,220,132,.35)}
.btn.danger{background:rgba(255,77,77,.16); border-color:rgba(255,77,77,.35)}
.btn.ghost{background:rgba(255,255,255,.06)}
.btn:disabled{opacity:.45; cursor:not-allowed}

#chat{
  position:fixed; top:76px; right:12px;
  width:min(360px,calc(100vw - 24px));
  height:min(62vh,520px);
  background:var(--glass); border:1px solid var(--line);
  border-radius:18px; box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
  display:none; z-index:55; overflow:hidden;
}
#chat header{
  padding:12px; border-bottom:1px solid rgba(255,255,255,.10);
  display:flex; justify-content:space-between; align-items:center;
}
#chat header .t{font-weight:900}
#chat header .s{font-size:12px; color:var(--muted)}
#chat main{padding:12px; height:calc(100% - 122px); overflow:auto}
.msg{
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10);
  border-radius:14px; padding:10px; margin-bottom:10px;
}
.msg .o{font-size:11px; color:var(--muted2)}
.msg .t{margin-top:6px; font-size:13px; white-space:pre-wrap; word-break:break-word;}
.msg .tr{margin-top:6px; font-size:12px; color:rgba(255,255,255,.8); white-space:pre-wrap; word-break:break-word;}
#chat footer{padding:10px; border-top:1px solid rgba(255,255,255,.10)}
#chat input{
  width:100%; padding:10px; border-radius:14px;
  background:rgba(0,0,0,.35); border:1px solid var(--line); color:#fff;
  outline:none;
}

#captions{
  position:fixed; left:12px; right:12px; bottom:78px;
  display:none; justify-content:center; z-index:40; pointer-events:none;
}
#captionsBox{
  width:min(860px,96vw); padding:10px 12px;
  background:rgba(0,0,0,.62); border:1px solid var(--line);
  border-radius:16px; text-align:center; box-shadow:var(--shadow);
}

#avatar{
  position:fixed; left:14px; bottom:14px;
  display:flex; align-items:center; gap:10px; z-index:70;
}
#avatarBtn{
  width:44px; height:44px; border-radius:50%;
  background:rgba(255,255,255,.08); border:1px solid var(--line);
  box-shadow:var(--shadow); cursor:pointer;
}
#avatarCard{
  display:none; max-width:320px;
  background:var(--glass); border:1px solid var(--line);
  border-radius:16px; padding:12px;
  box-shadow:var(--shadow); backdrop-filter: blur(14px);
}
#avatarCard p{margin:0; font-size:13px; color:var(--muted); line-height:1.35}

@media(max-width:420px){
  #pip{width:132px;height:184px; right:12px; bottom:12px}
}
</style>
</head>

<body>

<div id="topbar">
  <div id="brand">
    <div class="t">CONSIA ‚Äî LIVE</div>
    <div class="s">Presencia real ¬∑ Sin grabaciones</div>
  </div>
  <div id="status">
    <div class="pill"><span class="dot warn" id="dotLive"></span><span id="txtLive">LIVE: off</span></div>
    <div class="pill"><span class="dot warn" id="dotMedia"></span><span id="txtMedia">MEDIA: standby</span></div>
    <div class="pill"><span class="dot warn" id="dotPeer"></span><span id="txtPeer">PEER: esperando</span></div>
  </div>
</div>

<div id="stage">
  <video id="remoteVideo" autoplay playsinline></video>

  <div id="overlay">
    <div id="overlayCard">
      <h3 id="overlayTitle">Estamos preparando el LIVE</h3>
      <p id="overlayText">El host a√∫n no inici√≥ la sesi√≥n. Tu c√°mara y micr√≥fono est√°n apagados.</p>
      <div id="overlayBadge">üîí Modo soberano activo ‚Äî nada se graba, nada se guarda.</div>
    </div>
  </div>

  <div id="pip">
    <video id="localVideo" autoplay playsinline muted></video>
    <div id="pipBadges">
      <span id="bCam">üé• OFF</span>
      <span id="bMic">üéôÔ∏è OFF</span>
    </div>
  </div>
</div>

<div id="controls">
  <button class="btn" id="btnMedia">Activar c√°mara + audio</button>
  <button class="btn primary" id="btnStart">Iniciar LIVE (host)</button>
  <button class="btn ghost" id="btnCopy">Copiar link</button>
  <button class="btn ghost" id="btnChat">Chat</button>
  <button class="btn ghost" id="btnTrans">Traducci√≥n</button>
  <button class="btn danger" id="btnEnd">Finalizar LIVE</button>
</div>

<section id="chat">
  <header>
    <div>
      <div class="t">Chat en vivo</div>
      <div class="s">Ef√≠mero ¬∑ no se guarda</div>
    </div>
    <button class="btn ghost" id="btnChatClose">‚úï</button>
  </header>
  <main id="chatBody"></main>
  <footer>
    <input id="chatInput" placeholder="Escrib√≠ algo relevante para este momento‚Ä¶"/>
  </footer>
</section>

<div id="captions">
  <div id="captionsBox">Subt√≠tulos en tiempo real ¬∑ ef√≠meros</div>
</div>

<div id="avatar">
  <button id="avatarBtn">ü§ñ</button>
  <div id="avatarCard"><p id="avatarTxt"></p></div>
</div>

<script>
/* ===================== CONFIG ===================== */
const API_BASE = "https://api.consia.world";   // tu Worker en api.consia.world
const OWNER_TOKEN = ""; // SOLO SI VAS A HOSTEAR EN LOCAL. En producci√≥n, dejalo vac√≠o y us√° /live/create desde backend protegido.

/* ===================== STATE ===================== */
let role = "guest"; // host|guest
let room = "";
let sig = "";
let joinUrl = "";

let ws = null;
let pc = null;
let localStream = null;
let liveOn = false;

let transOn = false;

/* ===================== UI HELPERS ===================== */
const $ = (id)=>document.getElementById(id);
function setDot(id, cls){ $(id).className = "dot " + cls; }
function show(el, v){ el.style.display = v ? "" : "none"; }
function avatarSay(txt, autoHide=true){
  $("avatarTxt").textContent = txt;
  show($("avatarCard"), true);
  if(autoHide) setTimeout(()=>show($("avatarCard"), false), 4200);
}
function setOverlay(title, text){
  $("overlayTitle").textContent = title;
  $("overlayText").textContent = text;
  show($("overlay"), true);
}
function hideOverlay(){ show($("overlay"), false); }

function updateBadges(){
  const camOn = localStream?.getVideoTracks()?.some(t=>t.enabled && t.readyState==="live");
  const micOn = localStream?.getAudioTracks()?.some(t=>t.enabled && t.readyState==="live");

  $("bCam").textContent = camOn ? "üé• ON" : "üé• OFF";
  $("bMic").textContent = micOn ? "üéôÔ∏è ON" : "üéôÔ∏è OFF";

  if(camOn || micOn){
    setDot("dotMedia","good");
    $("txtMedia").textContent = "MEDIA: on";
  } else {
    setDot("dotMedia","warn");
    $("txtMedia").textContent = "MEDIA: standby";
  }
}

function setLiveUI(on){
  liveOn = on;
  if(on){
    setDot("dotLive","good"); $("txtLive").textContent = "LIVE: on";
    setDot("dotPeer","good"); $("txtPeer").textContent = "PEER: conectado";
    hideOverlay();
    if(transOn) show($("captions"), true);
  } else {
    setDot("dotLive","warn"); $("txtLive").textContent = "LIVE: off";
    setDot("dotPeer","warn"); $("txtPeer").textContent = "PEER: esperando";
    show($("captions"), false);
  }
}

function setGuestWaiting(){
  setDot("dotPeer","warn");
  $("txtPeer").textContent = "PEER: esperando";
  setOverlay("Estamos preparando el LIVE", "El host a√∫n no inici√≥ la sesi√≥n. Tu c√°mara y micr√≥fono est√°n apagados.");
}

function attachRemoteStream(stream){
  $("remoteVideo").srcObject = stream;
}

/* ===================== URL PARAMS ===================== */
function parseParams(){
  const p = new URLSearchParams(location.search);
  room = p.get("room") || "";
  sig  = p.get("sig")  || "";
  role = (p.get("role")==="host") ? "host" : (p.get("role")==="guest") ? "guest" : (room && sig ? "guest" : "host");
}

/* ===================== MEDIA ===================== */
async function startMedia(){
  if(localStream) return;
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  $("localVideo").srcObject = localStream;
  updateBadges();
  avatarSay("Activ√° el LIVE cuando est√©s listo. Nada se graba.");
}

/* ===================== WEBRTC ===================== */
function makePC(){
  // STUN p√∫blico (gratuito). Para ‚Äútop mundial‚Äù real, luego sumamos TURN.
  const cfg = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
  pc = new RTCPeerConnection(cfg);

  pc.onicecandidate = (ev)=>{
    if(ev.candidate) wsSend({type:"ice", candidate: ev.candidate});
  };

  pc.ontrack = (ev)=>{
    const [stream] = ev.streams;
    if(stream) attachRemoteStream(stream);
  };

  pc.onconnectionstatechange = ()=>{
    // opcional: estados para UX
  };
}

/* ===================== WS SIGNALING ===================== */
function wsUrl(){
  const u = new URL(API_BASE.replace("https://","wss://") + "/live/ws");
  u.searchParams.set("room", room);
  u.searchParams.set("role", role);
  if(role==="guest") u.searchParams.set("sig", sig);
  return u.toString();
}

function wsConnect(){
  return new Promise((resolve,reject)=>{
    ws = new WebSocket(wsUrl());
    ws.onopen = ()=>resolve();
    ws.onerror = (e)=>reject(e);
    ws.onmessage = (ev)=>onSignal(JSON.parse(ev.data));
    ws.onclose = ()=>{ /* nada */ };
  });
}

function wsSend(obj){
  if(ws && ws.readyState===1) ws.send(JSON.stringify(obj));
}

async function onSignal(msg){
  if(msg.type==="ready"){
    // server confirma room + roles
    if(role==="guest"){
      setGuestWaiting();
      avatarSay("Est√°s en sala segura. Vas a ver al host cuando inicie el LIVE.");
    }
    return;
  }
  if(msg.type==="host_connected"){
    if(role==="guest"){
      setOverlay("Host conectado", "El host est√° por iniciar el LIVE‚Ä¶");
    }
    return;
  }
  if(msg.type==="host_disconnected"){
    // host se fue -> corta todo del lado guest
    await hardStop("LIVE finalizado. Este momento ya no existe.");
    return;
  }
  if(msg.type==="end"){
    await hardStop("LIVE finalizado. Este momento ya no existe.");
    return;
  }

  // Offer/Answer/ICE
  if(msg.type==="offer" && role==="guest"){
    if(!pc) makePC();

    await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    // Si el guest quiere verse en miniatura, puede activar su media (opcional).
    // Para no pedir permisos de golpe, lo dejamos a decisi√≥n del usuario.
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    wsSend({type:"answer", sdp: pc.localDescription});

    setLiveUI(true);
    avatarSay("LIVE iniciado. Al cerrar, todo se apaga autom√°ticamente.");
    return;
  }

  if(msg.type==="answer" && role==="host"){
    if(pc) await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    setLiveUI(true);
    avatarSay("LIVE iniciado. Tu invitado ya est√° conectado.");
    return;
  }

  if(msg.type==="ice" && pc){
    try { await pc.addIceCandidate(msg.candidate); } catch(_) {}
    return;
  }

  // Chat
  if(msg.type==="chat"){
    renderChat(msg);
    return;
  }
}

/* ===================== ROOM CREATE (HOST) ===================== */
async function createRoom(){
  const res = await fetch(API_BASE + "/live/create", {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      ...(OWNER_TOKEN ? {"Authorization":"Bearer " + OWNER_TOKEN} : {})
    },
    body: JSON.stringify({ ttlSeconds: 180 })
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error("create failed: " + t);
  }
  const data = await res.json();
  room = data.room;
  sig = data.sig;
  joinUrl = data.joinUrl;
}

/* ===================== START LIVE (HOST) ===================== */
async function startLiveHost(){
  // gating: el host solo publica cuando toca iniciar
  if(!localStream){
    avatarSay("Primero activ√° tu c√°mara y audio.");
    return;
  }
  // Create room (server signed link)
  await createRoom();

  // Connect WS as host
  await wsConnect();
  wsSend({type:"host_announce"});

  // Create peer + add tracks
  makePC();
  localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

  // Create offer
  const offer = await pc.createOffer({offerToReceiveAudio:true, offerToReceiveVideo:true});
  await pc.setLocalDescription(offer);
  wsSend({type:"offer", sdp: pc.localDescription});

  // UI
  $("btnCopy").disabled = false;
  setOverlay("Compart√≠ el link", "Tu invitado ver√° el LIVE cuando acepte el link.");
  avatarSay("Copi√° el link y compartilo. El invitado te ver√° al iniciar.");
}

/* ===================== JOIN AS GUEST ===================== */
async function joinGuest(){
  if(!room || !sig){
    setOverlay("Falta el link", "Necesit√°s un link de invitaci√≥n v√°lido.");
    avatarSay("Ped√≠ al host el link de invitaci√≥n.");
    return;
  }
  await wsConnect();
  wsSend({type:"guest_announce"});
  setGuestWaiting();
}

/* ===================== CHAT ===================== */
function toggleChat(v){ show($("chat"), v); }
function renderChat(m){
  const d = document.createElement("div");
  d.className = "msg";
  const who = (m.from===role) ? "vos" : "otra persona";
  const original = (m.text||"").toString();

  d.innerHTML =
    `<div class="o">${who} ¬∑ ahora</div>`+
    `<div class="t">${escapeHtml(original)}</div>`+
    (transOn ? `<div class="tr">[traducci√≥n en tiempo real]</div>` : ``);

  $("chatBody").appendChild(d);
  $("chatBody").scrollTop = 1e9;
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

function sendChat(text){
  if(!liveOn){
    avatarSay("El chat se activa cuando el host inicia el LIVE.");
    return;
  }
  const payload = {type:"chat", text, from: role};
  wsSend(payload);
  // optimista local:
  renderChat(payload);
}

/* ===================== TRANSLATION (LIVE-ONLY UI) ===================== */
function toggleTrans(){
  transOn = !transOn;
  show($("captions"), transOn && liveOn);
  avatarSay(transOn
    ? "Traducci√≥n activada. Subt√≠tulos ef√≠meros en tiempo real."
    : "Traducci√≥n desactivada."
  );
}

/* ===================== HARD STOP ===================== */
async function hardStop(message){
  // notify peer
  try{ wsSend({type:"end"}); }catch(_){}

  // close webrtc
  try{ pc && pc.close(); }catch(_){}
  pc = null;

  // close ws
  try{ ws && ws.close(); }catch(_){}
  ws = null;

  // stop media
  try{
    if(localStream){
      localStream.getTracks().forEach(t=>t.stop());
      localStream = null;
      $("local
