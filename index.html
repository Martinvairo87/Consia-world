<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#07070a" />
  <title>CONSIA — LIVE</title>

  <style>
    :root{
      --bg:#07070a;
      --panel: rgba(18,18,24,.72);
      --panel2: rgba(18,18,24,.40);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.60);
      --ok: #37d07c;
      --warn:#ffcc66;
      --bad:#ff4d5f;
      --accent1:#7c5cff;
      --accent2:#25f0d3;

      --r: 18px;
      --r2: 22px;
      --shadow: 0 24px 60px rgba(0,0,0,.55);
      --shadow2: 0 14px 34px rgba(0,0,0,.40);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(124,92,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(37,240,211,.14), transparent 55%),
                  radial-gradient(800px 500px at 40% 90%, rgba(255,77,95,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: var(--sans);
      overflow:hidden;
    }

    /* ====== Intro Overlay ====== */
    .intro{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding: clamp(16px, 3vw, 40px);
      z-index: 50;
      background: radial-gradient(1100px 700px at 50% 40%, rgba(124,92,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 70% 50%, rgba(37,240,211,.14), transparent 55%),
                  rgba(0,0,0,.70);
      backdrop-filter: blur(14px);
    }
    .intro-card{
      width:min(980px, 100%);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: rgba(10,10,14,.65);
    }
    .intro-top{
      display:flex; gap:14px; align-items:center;
      padding: 16px 18px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(90deg, rgba(124,92,255,.16), rgba(37,240,211,.10));
    }
    .logo{
      width:42px; height:42px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 55%),
                  linear-gradient(135deg, rgba(124,92,255,.95), rgba(37,240,211,.75));
      box-shadow: 0 12px 24px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .intro-title{
      display:flex; flex-direction:column; line-height:1.2;
    }
    .intro-title b{ letter-spacing:.5px; }
    .intro-title small{ color:var(--muted); }

    .intro-media{
      position:relative;
      aspect-ratio: 16/9;
      background:#000;
    }
    /* ✅ CLAVE: NUNCA rotar; solo cover */
    .intro-media video{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      background:#000;
    }

    .intro-actions{
      display:flex; flex-wrap:wrap; gap:10px;
      padding: 14px 16px 16px;
      border-top: 1px solid var(--stroke);
      background: rgba(0,0,0,.25);
    }

    .btn{
      appearance:none; border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 600;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      min-width: 160px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.16); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(90deg, rgba(124,92,255,.95), rgba(37,240,211,.85));
      border-color: rgba(255,255,255,.18);
      color:#061016;
    }
    .btn.danger{ background: rgba(255,77,95,.10); border-color: rgba(255,77,95,.35); }
    .btn.ghost{ background: rgba(255,255,255,.04); }
    .pill{
      font-family: var(--mono);
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      color: rgba(255,255,255,.80);
      background: rgba(0,0,0,.30);
      display:inline-flex; gap:8px; align-items:center;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: rgba(255,255,255,.40); }
    .dot.ok{ background: var(--ok); }
    .dot.bad{ background: var(--bad); }
    .dot.warn{ background: var(--warn); }

    /* ====== App Shell ====== */
    .app{
      position:fixed; inset:0;
      display:grid;
      grid-template-rows: auto 1fr auto;
      padding: clamp(12px, 2.5vw, 22px);
      gap: 12px;
      z-index: 1;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
    }
    .top-left{ display:flex; gap:12px; align-items:center; }
    .title{
      display:flex; flex-direction:column; line-height:1.15;
    }
    .title b{ letter-spacing:.55px; }
    .title small{ color: var(--muted); }

    .top-right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .main{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 12px;
      min-height: 0;
    }

    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; }
    }

    .panel{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.35);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
      overflow:hidden;
      min-height: 0;
      backdrop-filter: blur(14px);
    }

    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(90deg, rgba(124,92,255,.10), rgba(37,240,211,.06));
    }
    .panel-head b{ letter-spacing:.35px; }
    .panel-body{ padding: 12px; min-height: 0; }

    /* Video stage */
    .stage{
      position:relative;
      height: min(62vh, 640px);
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.55);
    }
    .stage video, .stage canvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover;
    }

    .hud{
      position:absolute; left:12px; right:12px; top:12px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      z-index: 5;
    }

    .hud-right{
      margin-left:auto;
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }

    /* Self mini */
    .selfmini{
      position:absolute;
      right: 14px; bottom: 14px;
      width: min(26vw, 240px);
      aspect-ratio: 3/4;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.40);
      box-shadow: 0 18px 42px rgba(0,0,0,.55);
      z-index: 6;
      display:none;
    }
    .selfmini video{
      width:100%; height:100%;
      object-fit: cover;
      transform: scaleX(-1); /* espejo natural */
    }
    .selfmini .tag{
      position:absolute; left:10px; bottom:10px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.45);
      color: rgba(255,255,255,.85);
    }

    /* Controls */
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width: 520px){
      .controls{ grid-template-columns: 1fr; }
      .btn{ min-width: 100%; }
    }

    /* Right panel: Chat */
    .chatbox{
      display:flex; flex-direction:column;
      height: min(62vh, 640px);
      gap:10px;
    }
    .messages{
      flex: 1 1 auto;
      overflow:auto;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.35);
    }
    .msg{
      display:flex;
      gap:10px;
      margin-bottom: 10px;
      align-items:flex-start;
    }
    .bubble{
      max-width: 92%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .me .bubble{
      background: rgba(124,92,255,.16);
      border-color: rgba(124,92,255,.30);
      margin-left:auto;
    }
    .meta{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.55);
      margin-top: 4px;
    }

    .composer{
      display:flex; gap:10px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.35);
      align-items:center;
    }
    .composer input{
      flex:1;
      border:none;
      outline:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.10);
    }
    .composer input::placeholder{ color: rgba(255,255,255,.45); }

    .foot{
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(14px);
      color: rgba(255,255,255,.70);
      font-size: 12px;
      box-shadow: var(--shadow2);
    }
    .foot small{ color: rgba(255,255,255,.55); }
    .link{
      color: rgba(255,255,255,.82);
      text-decoration:none;
      border-bottom: 1px dashed rgba(255,255,255,.25);
    }

    /* Avatar Guide */
    .avatar{
      position: fixed;
      left: 16px;
      bottom: 18px;
      z-index: 30;
      display:flex;
      gap:10px;
      align-items:flex-end;
      pointer-events:none;
    }
    .orb{
      width: 54px; height: 54px;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.28), transparent 60%),
                  linear-gradient(135deg, rgba(124,92,255,.95), rgba(37,240,211,.75));
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.16);
      flex: 0 0 auto;
      pointer-events:auto;
    }
    .speak{
      max-width: min(520px, 82vw);
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.45);
      box-shadow: 0 18px 44px rgba(0,0,0,.45);
      pointer-events:auto;
    }
    .speak b{ letter-spacing:.25px; }
    .speak p{ margin:6px 0 0 0; color: rgba(255,255,255,.78); }

    /* Hidden by default */
    .hidden{ display:none !important; }
  </style>
</head>

<body>

  <!-- ===== INTRO ===== -->
  <section id="intro" class="intro">
    <div class="intro-card">
      <div class="intro-top">
        <div class="logo"></div>
        <div class="intro-title">
          <b>CONSIA — LIVE</b>
          <small>cámara + audio + presencia · web-first · sin storage · modo soberano</small>
        </div>
        <div style="margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
          <span class="pill"><span id="apiDot" class="dot warn"></span><span id="apiStatus">API: comprobando…</span></span>
          <span class="pill"><span class="dot"></span><span id="buildTag">build: web</span></span>
        </div>
      </div>

      <div class="intro-media">
        <!-- ✅ Sin rotaciones: el MP4 se ve bien en vertical / horizontal -->
        <video id="introVideo" playsinline muted preload="auto" controls>
          <source src="consia-intro.mp4" type="video/mp4" />
        </video>
      </div>

      <div class="intro-actions">
        <button id="playIntro" class="btn primary">▶︎ Play (30s)</button>
        <button id="skipIntro" class="btn ghost">Entrar al LIVE</button>
        <button id="privacyQuick" class="btn">Privacidad (1 línea)</button>
        <span class="pill" style="margin-left:auto;">
          <span class="dot"></span>
          <span>Tip: en iPad, si cámara/mic quedan activos, cerrar pestaña corta todo.</span>
        </span>
      </div>
    </div>
  </section>

  <!-- ===== APP ===== -->
  <div id="app" class="app hidden">
    <header class="topbar">
      <div class="top-left">
        <div class="logo" style="width:40px;height:40px;border-radius:14px;"></div>
        <div class="title">
          <b>CONSIA — LIVE</b>
          <small id="subtitle">teletransportación · modo standby</small>
        </div>
      </div>

      <div class="top-right">
        <span class="pill"><span id="camDot" class="dot bad"></span><span id="camState">Cámara</span></span>
        <span class="pill"><span id="micDot" class="dot bad"></span><span id="micState">Mic</span></span>
        <span class="pill"><span id="liveDot" class="dot bad"></span><span id="liveState">LIVE: off</span></span>
        <span class="pill"><span class="dot"></span><span id="roomPill">room: —</span></span>
      </div>
    </header>

    <main class="main">
      <!-- LEFT: VIDEO -->
      <section class="panel">
        <div class="panel-head">
          <b>TELETRANSPORTACIÓN</b>
          <span style="color:rgba(255,255,255,.65)">modo: <span id="modeLabel">standby</span></span>
        </div>

        <div class="panel-body">
          <div class="stage">
            <div class="hud">
              <span class="pill"><span class="dot"></span><span id="bgLabel">fondo: none</span></span>
              <span class="pill"><span class="dot"></span><span id="langLabel">idioma: auto</span></span>

              <div class="hud-right">
                <span class="pill"><span id="netDot" class="dot warn"></span><span id="netLabel">presencia: demo</span></span>
              </div>
            </div>

            <!-- Remote (futuro) -->
            <video id="remoteVideo" autoplay playsinline muted></video>

            <!-- Canvas para efectos (blur/background) -->
            <canvas id="fxCanvas"></canvas>

            <!-- Local (preview) -->
            <video id="localVideo" autoplay playsinline muted></video>

            <div id="selfmini" class="selfmini">
              <video id="selfminiVideo" autoplay playsinline muted></video>
              <div class="tag">Tú</div>
            </div>
          </div>

          <div class="controls">
            <button id="btnMedia" class="btn primary">Activar cámara + audio</button>
            <button id="btnStop" class="btn">Apagar</button>

            <button id="btnHost" class="btn">Iniciar LIVE (host)</button>
            <button id="btnJoin" class="btn">Unirme por link</button>

            <button id="btnCopy" class="btn">Copiar link invitación</button>
            <button id="btnEnd" class="btn danger">Finalizar LIVE</button>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <span class="pill"><span class="dot"></span><span><b>Fondo</b></span></span>
            <button id="bgNone" class="btn" style="min-width:auto;">None</button>
            <button id="bgBlur" class="btn" style="min-width:auto;">Blur</button>
            <button id="bgImage" class="btn" style="min-width:auto;">Imagen</button>
            <button id="bgDream" class="btn" style="min-width:auto;">Dream (API)</button>
            <input id="bgFile" type="file" accept="image/*" class="hidden" />
            <input id="dreamPrompt" type="text" placeholder="Dream prompt (opcional, requiere API)" style="flex:1; min-width:220px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06); color:var(--text); padding:10px 12px;" />
          </div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <span class="pill"><span class="dot"></span><span><b>Traducción</b></span></span>
            <button id="trOff" class="btn" style="min-width:auto;">Off</button>
            <button id="trOn" class="btn" style="min-width:auto;">On (API)</button>
            <select id="targetLang" style="min-width:160px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06); color:var(--text); padding:10px 12px;">
              <option value="es">ES</option>
              <option value="en">EN</option>
              <option value="pt">PT</option>
              <option value="fr">FR</option>
              <option value="it">IT</option>
              <option value="de">DE</option>
            </select>
            <span class="pill"><span class="dot"></span><span id="trStatus">traducción: off</span></span>
          </div>

        </div>
      </section>

      <!-- RIGHT: CHAT -->
      <section class="panel">
        <div class="panel-head">
          <b>CHAT</b>
          <span style="color:rgba(255,255,255,.65)">texto + voz (opcional)</span>
        </div>

        <div class="panel-body">
          <div class="chatbox">
            <div id="messages" class="messages"></div>

            <div class="composer">
              <input id="chatInput" type="text" placeholder="Escribe… (Enter para enviar)" />
              <button id="sendBtn" class="btn primary" style="min-width:auto;">Enviar</button>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <span class="pill"><span class="dot"></span><span id="chatMode">modo chat: local</span></span>
              <span class="pill"><span class="dot"></span><span id="chatHint">DataChannel se activa cuando conectemos WebRTC real</span></span>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="foot">
      <div>
        <small>CONSIA LIVE: no storage · no history · no exports · cortar sesión = apagar media</small>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <a class="link" href="privacy.html">Privacy</a>
        <a class="link" href="terms.html">Terms</a>
        <span class="pill"><span class="dot"></span><span id="apiFooter">web → api.consia.world</span></span>
      </div>
    </footer>
  </div>

  <!-- ===== Avatar Guide ===== -->
  <div id="avatar" class="avatar hidden">
    <div class="orb" title="CONSIA Guide"></div>
    <div class="speak">
      <b id="avTitle">CONSIA</b>
      <p id="avText">Bienvenido. Primero: activá cámara y audio. Luego: iniciá LIVE como host o unite por link.</p>
    </div>
  </div>

<script>
(() => {
  // ====== Config ======
  const API_BASE = "https://api.consia.world"; // tu Worker/API
  const APP_ORIGIN = location.origin;

  // ====== DOM ======
  const intro = document.getElementById("intro");
  const introVideo = document.getElementById("introVideo");
  const playIntro = document.getElementById("playIntro");
  const skipIntro = document.getElementById("skipIntro");
  const privacyQuick = document.getElementById("privacyQuick");

  const app = document.getElementById("app");

  const apiDot = document.getElementById("apiDot");
  const apiStatus = document.getElementById("apiStatus");
  const apiFooter = document.getElementById("apiFooter");

  const subtitle = document.getElementById("subtitle");
  const modeLabel = document.getElementById("modeLabel");

  const camDot = document.getElementById("camDot");
  const micDot = document.getElementById("micDot");
  const liveDot = document.getElementById("liveDot");

  const camState = document.getElementById("camState");
  const micState = document.getElementById("micState");
  const liveState = document.getElementById("liveState");
  const roomPill = document.getElementById("roomPill");

  const netDot = document.getElementById("netDot");
  const netLabel = document.getElementById("netLabel");

  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const fxCanvas = document.getElementById("fxCanvas");
  const selfmini = document.getElementById("selfmini");
  const selfminiVideo = document.getElementById("selfminiVideo");

  const btnMedia = document.getElementById("btnMedia");
  const btnStop = document.getElementById("btnStop");
  const btnHost = document.getElementById("btnHost");
  const btnJoin = document.getElementById("btnJoin");
  const btnCopy = document.getElementById("btnCopy");
  const btnEnd = document.getElementById("btnEnd");

  const bgLabel = document.getElementById("bgLabel");
  const bgNone = document.getElementById("bgNone");
  const bgBlur = document.getElementById("bgBlur");
  const bgImage = document.getElementById("bgImage");
  const bgDream = document.getElementById("bgDream");
  const bgFile = document.getElementById("bgFile");
  const dreamPrompt = document.getElementById("dreamPrompt");

  const trOff = document.getElementById("trOff");
  const trOn = document.getElementById("trOn");
  const targetLang = document.getElementById("targetLang");
  const trStatus = document.getElementById("trStatus");
  const langLabel = document.getElementById("langLabel");

  const messages = document.getElementById("messages");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatMode = document.getElementById("chatMode");
  const chatHint = document.getElementById("chatHint");

  const avatar = document.getElementById("avatar");
  const avTitle = document.getElementById("avTitle");
  const avText = document.getElementById("avText");

  // ====== State ======
  let mediaStream = null;
  let roomId = null;
  let isHost = false;
  let isLive = false;

  let bgMode = "none"; // none|blur|image|dream
  let bgImageObj = null;
  let trEnabled = false;

  // For FX render
  const ctx = fxCanvas.getContext("2d");
  let fxRaf = null;

  // ====== Helpers ======
  const uid = () => Math.random().toString(16).slice(2,10);
  const now = () => new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  const setDot = (el, st) => {
    el.classList.remove("ok","warn","bad");
    if(st==="ok") el.classList.add("ok");
    else if(st==="warn") el.classList.add("warn");
    else el.classList.add("bad");
  };
  const say = (title, text) => {
    avatar.classList.remove("hidden");
    avTitle.textContent = title;
    avText.textContent = text;
  };
  const addMsg = async (text, who="me", translated=null) => {
    const row = document.createElement("div");
    row.className = `msg ${who==="me" ? "me" : ""}`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${who==="me" ? "tú" : "consia"} · ${now()}`;

    const wrap = document.createElement("div");
    wrap.appendChild(bubble);
    wrap.appendChild(meta);

    row.appendChild(wrap);

    if(translated){
      const t = document.createElement("div");
      t.className = "meta";
      t.style.marginTop = "6px";
      t.textContent = `→ ${translated}`;
      wrap.appendChild(t);
    }

    messages.appendChild(row);
    messages.scrollTop = messages.scrollHeight;
  };

  // ====== API health ======
  async function apiPing(){
    try{
      const r = await fetch(`${API_BASE}/health`, { method:"GET", cache:"no-store" });
      if(!r.ok) throw new Error("bad");
      setDot(apiDot,"ok");
      apiStatus.textContent = "API: ok";
      apiFooter.textContent = `web → ${new URL(API_BASE).host}`;
    }catch(e){
      setDot(apiDot,"warn");
      apiStatus.textContent = "API: demo (sin health)";
      apiFooter.textContent = `web → ${new URL(API_BASE).host}`;
    }
  }

  // ====== Intro flow ======
  playIntro.onclick = () => {
    introVideo.muted = false;
    introVideo.play().catch(()=>{});
  };
  privacyQuick.onclick = () => {
    alert("CONSIA LIVE no guarda video/audio/chat. Se corta al apagar o cerrar la pestaña. Sin storage. Sin history.");
  };
  skipIntro.onclick = () => openApp();

  introVideo.addEventListener("ended", () => openApp());

  function openApp(){
    intro.classList.add("hidden");
    app.classList.remove("hidden");
    say("CONSIA", "Bienvenido. 1) Activá cámara + audio. 2) Iniciar LIVE (host) o Unirme por link. 3) Podés chatear y activar traducción cuando conectemos el endpoint.");
    // load room from URL if present
    const u = new URL(location.href);
    const r = u.searchParams.get("room");
    if(r){
      roomId = r;
      roomPill.textContent = `room: ${roomId}`;
      say("CONSIA", "Detecté un room por link. Si el host ya inició LIVE, unite. Si no, pedile que inicie LIVE y copie el link.");
    }else{
      roomPill.textContent = "room: —";
    }
  }

  // ====== Media ======
  async function startMedia(){
    if(mediaStream) return mediaStream;

    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: { width: {ideal:1280}, height: {ideal:720}, facingMode:"user" },
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
      });

      localVideo.srcObject = mediaStream;
      selfminiVideo.srcObject = mediaStream;
      selfmini.style.display = "block";

      setDot(camDot,"ok"); camState.textContent = "Cámara: on";
      setDot(micDot,"ok"); micState.textContent = "Mic: on";
      subtitle.textContent = "teletransportación · listo";
      say("CONSIA", "Perfecto. Ahora podés iniciar LIVE como host o unirte por link. Recordá: cerrar pestaña corta cámara y mic.");
      // start FX loop if needed
      ensureFxLoop();

      return mediaStream;
    }catch(err){
      setDot(camDot,"bad"); camState.textContent = "Cámara: denied";
      setDot(micDot,"bad"); micState.textContent = "Mic: denied";
      alert("Permisos de cámara/mic rechazados. Activá permisos en Safari y reintentá.");
      throw err;
    }
  }

  function stopMedia(){
    if(mediaStream){
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
    }
    localVideo.srcObject = null;
    selfminiVideo.srcObject = null;
    selfmini.style.display = "none";

    setDot(camDot,"bad"); camState.textContent = "Cámara";
    setDot(micDot,"bad"); micState.textContent = "Mic";

    // stop FX
    if(fxRaf) cancelAnimationFrame(fxRaf);
    fxRaf = null;
    ctx.clearRect(0,0,fxCanvas.width, fxCanvas.height);

    say("CONSIA", "Media apagado. En CONSIA LIVE, apagar es real: no queda nada corriendo.");
  }

  btnMedia.onclick = () => startMedia();
  btnStop.onclick = () => {
    isLive = false;
    setDot(liveDot,"bad"); liveState.textContent = "LIVE: off";
    modeLabel.textContent = "standby";
    subtitle.textContent = "teletransportación · modo standby";
    stopMedia();
  };

  // ====== Room / Link ======
  function ensureRoom(){
    if(!roomId) roomId = `rw-${uid()}${uid()}`.slice(0,10);
    roomPill.textContent = `room: ${roomId}`;
    return roomId;
  }

  btnCopy.onclick = async () => {
    const r = ensureRoom();
    const link = `${APP_ORIGIN}?room=${encodeURIComponent(r)}`;
    try{
      await navigator.clipboard.writeText(link);
      say("CONSIA", "Link copiado. Cuando lo compartas, la otra persona entra al room. Para ver/escuchar, el host debe iniciar LIVE.");
      addMsg(`Link invitación: ${link}`, "me");
    }catch(e){
      prompt("Copiá el link:", link);
    }
  };

  // ====== LIVE (demo UX + preparado para WebRTC real) ======
  btnHost.onclick = async () => {
    await startMedia();
    ensureRoom();
    isHost = true;
    isLive = true;
    setDot(liveDot,"ok"); liveState.textContent = "LIVE: on";
    modeLabel.textContent = "host";
    subtitle.textContent = "LIVE activo · host";
    setDot(netDot,"warn"); netLabel.textContent = "presencia: demo (WebRTC real pendiente)";
    say("CONSIA", "Host activo. Copiá el link y compartilo. WebRTC real (offer/answer/ICE) lo conectamos al Worker en el siguiente paso.");
  };

  btnJoin.onclick = async () => {
    await startMedia();
    ensureRoom();
    isHost = false;
    isLive = true;
    setDot(liveDot,"ok"); liveState.textContent = "LIVE: on";
    modeLabel.textContent = "join";
    subtitle.textContent = "LIVE activo · join";
    setDot(netDot,"warn"); netLabel.textContent = "presencia: demo (WebRTC real pendiente)";
    say("CONSIA", "Listo. Estás en modo join. Cuando conectemos WebRTC real, vas a ver el video remoto y el chat via DataChannel.");
  };

  btnEnd.onclick = () => {
    isLive = false;
    setDot(liveDot,"bad"); liveState.textContent = "LIVE: off";
    modeLabel.textContent = "standby";
    subtitle.textContent = "teletransportación · modo standby";
    say("CONSIA", "LIVE finalizado. Si compartiste link, generá uno nuevo para una sesión nueva.");
  };

  // ====== Background FX ======
  function setBg(mode){
    bgMode = mode;
    bgLabel.textContent = `fondo: ${mode}`;
    if(mode==="none"){
      document.getElementById("bgLabel").textContent = "fondo: none";
      say("CONSIA", "Fondo en None. Imagen pura de cámara.");
    }
    if(mode==="blur"){
      say("CONSIA", "Fondo Blur (costo 0). Ideal para privacidad y estética premium.");
    }
    if(mode==="image"){
      say("CONSIA", "Fondo Imagen (costo 0). Elegí una imagen y CONSIA la usa detrás.");
    }
    if(mode==="dream"){
      say("CONSIA", "Dream requiere API (porque generar fondos con IA tiene costo). Si no hay API, queda en demo.");
    }
    ensureFxLoop();
  }

  bgNone.onclick = () => setBg("none");
  bgBlur.onclick = () => setBg("blur");
  bgImage.onclick = () => { bgFile.click(); };
  bgFile.onchange = (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = () => {
      bgImageObj = img;
      setBg("image");
    };
    img.src = url;
  };
  bgDream.onclick = async () => {
    setBg("dream");
    // optional API call
    const prompt = dreamPrompt.value?.trim() || "cinematic abstract neon depth";
    try{
      const r = await fetch(`${API_BASE}/bg`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ prompt, w: 1280, h: 720 })
      });
      if(!r.ok) throw new Error("no bg");
      const data = await r.json();
      if(!data?.imageUrl) throw new Error("bad");
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        bgImageObj = img;
        setBg("image");
        say("CONSIA", "Dream aplicado. (Nota: esto requiere tu endpoint /bg activo.)");
      };
      img.src = data.imageUrl;
    }catch(e){
      alert("Dream requiere endpoint API /bg. Ahora queda en modo demo (sin generar).");
      setBg("none");
    }
  };

  function ensureFxLoop(){
    if(!mediaStream) return;
    if(!fxRaf) fxLoop();
  }

  function fxLoop(){
    const v = localVideo;
    const w = v.videoWidth || 1280;
    const h = v.videoHeight || 720;

    // size canvas to stage size
    const rect = fxCanvas.getBoundingClientRect();
    fxCanvas.width = Math.max(2, Math.floor(rect.width));
    fxCanvas.height = Math.max(2, Math.floor(rect.height));

    // draw background first if needed
    ctx.clearRect(0,0,fxCanvas.width, fxCanvas.height);

    if(bgMode === "none"){
      // hide canvas effect visually by clearing
      // but keep loop alive lightly
    } else {
      // 1) background layer
      if(bgMode === "image" && bgImageObj){
        drawCoverImage(bgImageObj, fxCanvas.width, fxCanvas.height);
      } else {
        // default background
        ctx.fillStyle = "rgba(0,0,0,0.55)";
        ctx.fillRect(0,0,fxCanvas.width, fxCanvas.height);
      }

      // 2) draw blurred camera as "presence" style (costo 0)
      if(bgMode === "blur"){
        ctx.filter = "blur(16px) saturate(1.15) brightness(.95)";
        drawCoverVideo(v, fxCanvas.width, fxCanvas.height);
        ctx.filter = "none";
        // vignette
        ctx.fillStyle = "rgba(0,0,0,0.18)";
        ctx.fillRect(0,0,fxCanvas.width, fxCanvas.height);
      }
    }

    fxRaf = requestAnimationFrame(fxLoop);
  }

  function drawCoverVideo(video, cw, ch){
    const vw = video.videoWidth || 1280;
    const vh = video.videoHeight || 720;
    const vr = vw / vh;
    const cr = cw / ch;

    let sw, sh, sx, sy;
    if(vr > cr){
      sh = vh;
      sw = vh * cr;
      sx = (vw - sw)/2;
      sy = 0;
    }else{
      sw = vw;
      sh = vw / cr;
      sx = 0;
      sy = (vh - sh)/2;
    }
    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, cw, ch);
  }

  function drawCoverImage(img, cw, ch){
    const iw = img.naturalWidth;
    const ih = img.naturalHeight;
    const ir = iw/ih;
    const cr = cw/ch;

    let sw, sh, sx, sy;
    if(ir > cr){
      sh = ih;
      sw = ih * cr;
      sx = (iw - sw)/2;
      sy = 0;
    }else{
      sw = iw;
      sh = iw / cr;
      sx = 0;
      sy = (ih - sh)/2;
    }
    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, cw, ch);
  }

  // ====== Chat ======
  async function sendChat(){
    const text = chatInput.value.trim();
    if(!text) return;
    chatInput.value = "";
    chatInput.focus();

    // Translation (API optional)
    let translated = null;
    if(trEnabled){
      try{
        const r = await fetch(`${API_BASE}/translate`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ text, to: targetLang.value })
        });
        if(r.ok){
          const data = await r.json();
          translated = data?.translated || null;
        }
      }catch(e){}
    }

    addMsg(text, "me", translated);
    // Future: send over DataChannel
  }

  sendBtn.onclick = sendChat;
  chatInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter") sendChat();
  });

  // ====== Translation toggles ======
  trOff.onclick = () => {
    trEnabled = false;
    trStatus.textContent = "traducción: off";
    say("CONSIA", "Traducción apagada. (Cero costo). Si querés traducción en vivo estilo OpenAI, necesita endpoint en tu API.");
  };
  trOn.onclick = () => {
    trEnabled = true;
    trStatus.textContent = "traducción: on (API)";
    say("CONSIA", "Traducción activada (requiere API). Si el endpoint /translate no está listo, queda en demo.");
  };
  targetLang.onchange = () => {
    langLabel.textContent = `idioma: → ${targetLang.value.toUpperCase()}`;
  };

  // ====== Safety: stop tracks on page hide ======
  document.addEventListener("visibilitychange", () => {
    if(document.hidden){
      // No forzamos apagar al ocultar, pero lo dejamos listo si querés policy estricta
    }
  });

  // ====== Start ======
  apiPing();
  addMsg("CONSIA listo. Chat local activo. WebRTC real + DataChannel viene en el próximo commit.", "consia");
})();
</script>

</body>
</html>
