<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CONSIA Realtime Test</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial; margin: 20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0; }
    input, button, textarea { font-size: 16px; padding: 10px; }
    input { width: 420px; max-width: 100%; }
    textarea { width: 100%; height: 120px; }
    pre { background:#111; color:#0f0; padding:12px; border-radius:10px; overflow:auto; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eee; }
    .ok { background:#d1fae5; }
    .bad { background:#fee2e2; }
  </style>
</head>
<body>
  <h2>CONSIA Realtime Test</h2>

  <div class="row">
    <span id="status" class="pill bad">DISCONNECTED</span>
  </div>

  <div class="row">
    <input id="wsUrl" placeholder="wss://api.consia.world/ws?t=TU_DEVICE_TOKEN"
           value="wss://api.consia.world/ws?t=TU_DEVICE_TOKEN" />
  </div>

  <div class="row">
    <button id="connectBtn">Conectar WS</button>
    <button id="closeBtn">Cerrar WS</button>
  </div>

  <h3>Enviar</h3>
  <div class="row">
    <input id="msg" placeholder='{"type":"ping"} o texto simple' />
    <button id="sendBtn">Enviar</button>
  </div>

  <h3>Mic (prueba local)</h3>
  <div class="row">
    <button id="micBtn">Activar Mic</button>
    <span id="micStatus" class="pill bad">MIC OFF</span>
  </div>
  <div class="row">
    <progress id="vu" value="0" max="100" style="width:420px;max-width:100%"></progress>
  </div>

  <h3>Log</h3>
  <pre id="log"></pre>

<script>
  let ws = null;
  const logEl = document.getElementById("log");
  const statusEl = document.getElementById("status");

  function log(...a){
    const line = a.map(x => typeof x === "string" ? x : JSON.stringify(x)).join(" ");
    logEl.textContent = (line + "\n" + logEl.textContent).slice(0, 8000);
  }

  function setStatus(ok, text){
    statusEl.textContent = text;
    statusEl.className = "pill " + (ok ? "ok" : "bad");
  }

  document.getElementById("connectBtn").onclick = () => {
    try {
      const url = document.getElementById("wsUrl").value.trim();
      ws = new WebSocket(url);

      ws.onopen = () => { setStatus(true, "CONNECTED"); log("WS open"); };
      ws.onmessage = (e) => { log("WS msg:", e.data); };
      ws.onerror = (e) => { log("WS error"); };
      ws.onclose = () => { setStatus(false, "DISCONNECTED"); log("WS close"); ws = null; };

    } catch (err) {
      log("Connect error:", String(err));
    }
  };

  document.getElementById("closeBtn").onclick = () => {
    if (ws) ws.close();
  };

  document.getElementById("sendBtn").onclick = () => {
    if (!ws || ws.readyState !== 1) return log("WS not connected");
    const m = document.getElementById("msg").value.trim();
    if (!m) return;

    // si parece JSON, lo mandamos igual como string (tu worker parsea si puede)
    ws.send(m);
    log("WS sent:", m);
  };

  // MIC: prueba local (VU meter). No streamea aÃºn.
  let audioCtx, analyser, micStream, raf;
  const micBtn = document.getElementById("micBtn");
  const micStatus = document.getElementById("micStatus");
  const vu = document.getElementById("vu");

  micBtn.onclick = async () => {
    try {
      if (micStream) return;

      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      src.connect(analyser);

      micStatus.textContent = "MIC ON";
      micStatus.className = "pill ok";

      const data = new Uint8Array(analyser.fftSize);
      const tick = () => {
        analyser.getByteTimeDomainData(data);
        // RMS simple
        let sum = 0;
        for (let i=0;i<data.length;i++){
          const v = (data[i]-128)/128;
          sum += v*v;
        }
        const rms = Math.sqrt(sum/data.length);
        vu.value = Math.min(100, Math.round(rms*200));
        raf = requestAnimationFrame(tick);
      };
      tick();

      log("MIC ready (local test)");
    } catch (e) {
      log("MIC error:", String(e));
      micStatus.textContent = "MIC OFF";
      micStatus.className = "pill bad";
    }
  };
</script>
</body>
</html>
