<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#05070b" />
  <title>CONSIA</title>
  <style>
    :root{
      --bg:#05070b;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --muted2:rgba(255,255,255,.40);
      --brand:#66d3ff;
      --brand2:#3aa0ff;
      --ok:#47e6a0;
      --warn:#ffd26a;
      --err:#ff6b6b;
      --shadow: 0 24px 80px rgba(0,0,0,.55);
      --r:22px;
      --r2:16px;
      --pad:18px;
      --pad2:14px;
      --max:1180px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(102,211,255,.18), transparent 55%),
        radial-gradient(900px 620px at 80% 30%, rgba(58,160,255,.14), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(71,230,160,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--max);margin:0 auto;padding:24px 16px 32px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 8px 18px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.24em;
      text-transform:uppercase;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #bff1ff, var(--brand));
      box-shadow: 0 0 22px rgba(102,211,255,.35);
    }
    .right{
      display:flex;align-items:center;gap:10px;
    }
    .pill{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      padding:8px 10px;border-radius:999px;
      color:var(--muted);
      font-size:12px;
      display:flex;align-items:center;gap:8px;
    }
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:999px;
      font-size:13px;cursor:pointer;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{
      border-color:rgba(102,211,255,.30);
      background:linear-gradient(180deg, rgba(102,211,255,.20), rgba(58,160,255,.10));
      box-shadow: 0 0 0 1px rgba(102,211,255,.10) inset;
    }
    .btn.ghost{background:transparent}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }

    /* Avatar Panel */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .avatarCard{min-height:520px}
    .avatarStage{
      position:relative;
      height:320px;
      background:
        radial-gradient(700px 380px at 35% 25%, rgba(102,211,255,.20), transparent 60%),
        radial-gradient(700px 420px at 70% 35%, rgba(58,160,255,.16), transparent 60%),
        radial-gradient(700px 480px at 50% 90%, rgba(71,230,160,.08), transparent 65%),
        rgba(0,0,0,.35);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .avatarVideo{
      position:absolute;inset:0;
      width:100%;height:100%;object-fit:cover;
      filter:saturate(1.08) contrast(1.05) brightness(.95);
      opacity:.86;
    }
    .avatarOverlay{
      position:absolute;inset:0;
      background:
        radial-gradient(400px 260px at 25% 30%, rgba(102,211,255,.18), transparent 65%),
        radial-gradient(380px 280px at 75% 35%, rgba(58,160,255,.12), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.55));
      pointer-events:none;
    }
    .avatarPulse{
      position:absolute;left:16px;top:14px;
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      color:rgba(255,255,255,.85);
      font-size:12px;
    }
    .pulseDot{
      width:10px;height:10px;border-radius:50%;
      background:rgba(71,230,160,.95);
      box-shadow:0 0 18px rgba(71,230,160,.35);
      animation:pulse 1.4s infinite ease-in-out;
      opacity:.9;
    }
    @keyframes pulse{
      0%{transform:scale(.9);opacity:.6}
      50%{transform:scale(1.15);opacity:1}
      100%{transform:scale(.9);opacity:.6}
    }
    .avatarHint{
      position:absolute;right:12px;top:12px;
      display:flex;gap:8px;align-items:center;
    }
    .miniBtn{
      width:38px;height:38px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.28);
      cursor:pointer;
      display:grid;place-items:center;
      transition:.15s ease;
    }
    .miniBtn:hover{background:rgba(255,255,255,.10)}
    .miniBtn svg{opacity:.86}
    .avatarBody{padding:14px 14px 16px}
    .avatarLine{
      font-size:14px;line-height:1.35;color:rgba(255,255,255,.88);
      margin:0 0 10px 0;
    }
    .sub{
      font-size:12px;color:var(--muted);
      margin:0 0 14px 0;
    }
    .modes{
      display:flex;flex-wrap:wrap;gap:8px;
      margin:0 0 12px 0;
    }
    .mode{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;cursor:pointer;
      display:flex;align-items:center;gap:8px;
    }
    .mode.active{
      border-color:rgba(102,211,255,.35);
      background:linear-gradient(180deg, rgba(102,211,255,.18), rgba(58,160,255,.10));
    }
    .quickGrid{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
    }
    .qcard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
      transition:.15s ease;
      min-height:74px;
    }
    .qcard:hover{background:rgba(255,255,255,.08)}
    .qtitle{font-size:13px;color:rgba(255,255,255,.90);margin:0 0 6px 0;font-weight:600}
    .qdesc{font-size:12px;color:var(--muted);margin:0}

    /* Chat panel */
    .chatCard{min-height:520px;display:flex;flex-direction:column}
    .chatHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .chatTitle{font-weight:650;font-size:13px;color:rgba(255,255,255,.9);letter-spacing:.02em}
    .chatTools{display:flex;gap:8px;align-items:center}
    .chatBody{
      padding:14px;
      flex:1;
      overflow:auto;
    }
    .msg{display:flex;gap:10px;margin:0 0 12px 0}
    .bubble{
      max-width:85%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      font-size:14px;line-height:1.35;color:rgba(255,255,255,.90);
      white-space:pre-wrap;
    }
    .msg.me{justify-content:flex-end}
    .msg.me .bubble{
      background:linear-gradient(180deg, rgba(102,211,255,.20), rgba(58,160,255,.10));
      border-color:rgba(102,211,255,.25);
    }
    .tag{
      font-size:11px;color:var(--muted2);
      margin-top:6px;
    }
    .composer{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;gap:10px;align-items:flex-end;
      background:rgba(0,0,0,.10);
    }
    .inputWrap{
      flex:1;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      border-radius:18px;
      padding:10px 12px;
      display:flex;gap:10px;align-items:flex-end;
    }
    textarea{
      width:100%;
      border:0;outline:0;
      background:transparent;
      resize:none;
      color:rgba(255,255,255,.92);
      font: 14px/1.35 var(--font);
      min-height:22px;
      max-height:120px;
    }
    textarea::placeholder{color:rgba(255,255,255,.35)}
    .send{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(102,211,255,.25);
      background:linear-gradient(180deg, rgba(102,211,255,.20), rgba(58,160,255,.10));
      display:grid;place-items:center;
      cursor:pointer;
      transition:.15s ease;
    }
    .send:hover{filter:brightness(1.06)}
    .kbdHint{
      font-size:12px;color:rgba(255,255,255,.45);
      padding:0 2px;
    }

    /* Modal */
    .modal{
      position:fixed;inset:0;
      background:rgba(0,0,0,.60);
      display:none;align-items:center;justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal.on{display:flex}
    .modalBox{
      width:min(820px, 100%);
      border-radius:24px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: 0 28px 120px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .modalTop{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalTitle{font-weight:700;font-size:13px;color:rgba(255,255,255,.90)}
    .modalBody{padding:16px}
    .note{
      color:rgba(255,255,255,.82);
      font-size:14px;line-height:1.4;margin:0 0 10px 0;
    }
    .small{
      color:rgba(255,255,255,.55);
      font-size:12px;margin:0;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" aria-label="CONSIA">
        <span class="dot" aria-hidden="true"></span>
        <span>CONSIA</span>
      </div>
      <div class="right">
        <div class="pill" id="statusPill">
          <span id="statusDot" style="width:8px;height:8px;border-radius:50%;background:var(--muted2);display:inline-block"></span>
          <span id="statusText">‚Ä¶</span>
        </div>
        <button class="btn ghost" id="langBtn" title="Idioma">üåê</button>
        <button class="btn" id="resetBtn" title="Reiniciar sesi√≥n">Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- AVATAR / GUIDANCE -->
      <div class="card avatarCard">
        <div class="avatarStage" id="avatarStage">
          <!-- ‚úÖ Avatar hiperrealista: reemplaz√° src por tu video hiperrealista (mp4/webm) cuando lo tengas -->
          <video class="avatarVideo" id="avatarVideo" autoplay muted loop playsinline
            src="avatar/consia-avatar-hyperreal.webm"></video>

          <div class="avatarOverlay"></div>

          <div class="avatarPulse">
            <span class="pulseDot" id="liveDot"></span>
            <span id="avatarState">CONSIA ‚Ä¢ ACTIVA</span>
          </div>

          <div class="avatarHint">
            <div class="miniBtn" id="btnVoice" title="Voz">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3Z" stroke="white" opacity=".9" stroke-width="1.6"/>
                <path d="M19 11a7 7 0 0 1-14 0" stroke="white" opacity=".9" stroke-width="1.6" stroke-linecap="round"/>
                <path d="M12 18v3" stroke="white" opacity=".9" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="miniBtn" id="btnFaceTime" title="FaceTime">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M15 10.5V8.8A2.8 2.8 0 0 0 12.2 6H7.8A2.8 2.8 0 0 0 5 8.8v6.4A2.8 2.8 0 0 0 7.8 18h4.4A2.8 2.8 0 0 0 15 15.2v-1.7" stroke="white" opacity=".9" stroke-width="1.6" stroke-linecap="round"/>
                <path d="M15 10.5 19 8v8l-4-2.5" stroke="white" opacity=".9" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="miniBtn" id="btnHyper" title="Hyperrealismo">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 21s7-4.5 7-11a7 7 0 1 0-14 0c0 6.5 7 11 7 11Z" stroke="white" opacity=".9" stroke-width="1.6"/>
                <path d="M9.5 10.5a2.5 2.5 0 0 0 5 0" stroke="white" opacity=".9" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="avatarBody">
          <p class="avatarLine" id="avatarLine">Decime qu√© quer√©s. Yo me encargo.</p>
          <p class="sub" id="avatarSub">Tip: escrib√≠ ‚Äú.‚Äù para activar la magia instant√°nea.</p>

          <div class="modes" role="tablist" aria-label="Modos">
            <div class="mode active" data-mode="chat">üí¨ <span id="mChat">Chat</span></div>
            <div class="mode" data-mode="voice">üéôÔ∏è <span id="mVoice">Voz</span></div>
            <div class="mode" data-mode="facetime">üìπ <span id="mFace">FaceTime</span></div>
            <div class="mode" data-mode="hyperrealism">‚ú® <span id="mHyper">Hyperrealismo</span></div>
          </div>

          <div class="quickGrid" id="quickGrid">
            <div class="qcard" data-q="1">
              <p class="qtitle" id="q1t">Explorar</p>
              <p class="qdesc" id="q1d">Ver todo lo que CONSIA puede hacer.</p>
            </div>
            <div class="qcard" data-q="2">
              <p class="qtitle" id="q2t">Hacer ahora</p>
              <p class="qdesc" id="q2d">Planificar, resumir, decidir, ejecutar.</p>
            </div>
            <div class="qcard" data-q="3">
              <p class="qtitle" id="q3t">Soporte</p>
              <p class="qdesc" id="q3d">Cuenta, pagos, errores, ayuda.</p>
            </div>
            <div class="qcard" data-q=".">
              <p class="qtitle" id="q4t">Magia ‚Äú.‚Äù</p>
              <p class="qdesc" id="q4d">Un bot√≥n. Un punto. Y listo.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="card chatCard">
        <div class="chatHead">
          <div class="chatTitle" id="chatTitle">CONSIA ‚Ä¢ CORE</div>
          <div class="chatTools">
            <button class="btn" id="speakBtn" title="Leer respuesta">üîä</button>
            <button class="btn primary" id="magicBtn" title="Magia">.</button>
          </div>
        </div>

        <div class="chatBody" id="chatBody"></div>

        <div class="composer">
          <div class="inputWrap">
            <textarea id="input" rows="1" placeholder="Decime qu√© quer√©s. (o escrib√≠ ‚Äú.‚Äù)"></textarea>
          </div>
          <div class="send" id="sendBtn" title="Enviar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M3 12 21 3l-5 18-5-7-8-2Z" stroke="white" stroke-width="1.6" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
        <div class="kbdHint" style="padding:10px 16px 14px">
          Enter = enviar ‚Ä¢ Shift+Enter = salto ‚Ä¢ <span style="opacity:.9">‚Äú.‚Äù</span> = magia
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal" id="modal">
    <div class="modalBox">
      <div class="modalTop">
        <div class="modalTitle" id="modalTitle">CONSIA</div>
        <button class="btn" id="closeModal">Cerrar</button>
      </div>
      <div class="modalBody">
        <p class="note" id="modalNote"></p>
        <p class="small" id="modalSmall"></p>
        <div class="row" id="modalActions"></div>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       CONFIG
       ========================= */
    const API_URL = "https://api.consia.world/ask";
    const HEALTH_URL = "https://api.consia.world/health";

    const LS = {
      sid: "consia_sid_v1",
      lang: "consia_lang_v1",
      mode: "consia_mode_v1",
      muted: "consia_muted_v1"
    };

    /* =========================
       I18N (global)
       ========================= */
    const I18N = {
      es: {
        status_ok: "Online",
        status_down: "Offline",
        avatar_line: "Decime qu√© quer√©s. Yo me encargo.",
        avatar_sub: "Tip: escrib√≠ ‚Äú.‚Äù para activar la magia instant√°nea.",
        explore: "Explorar",
        do_now: "Hacer ahora",
        support: "Soporte",
        magic_dot: "Magia ‚Äú.‚Äù",
        q1d: "Ver todo lo que CONSIA puede hacer.",
        q2d: "Planificar, resumir, decidir, ejecutar.",
        q3d: "Cuenta, pagos, errores, ayuda.",
        q4d: "Un bot√≥n. Un punto. Y listo.",
        placeholder: "Decime qu√© quer√©s. (o escrib√≠ ‚Äú.‚Äù)",
        core_title: "CONSIA ‚Ä¢ CORE",
        modal_voice: "Voz",
        modal_facetime: "FaceTime",
        modal_hyper: "Hyperrealismo",
        m_voice: "Voz",
        m_facetime: "FaceTime",
        m_hyper: "Hyperrealismo",
        choose_3: "Eleg√≠ 1, 2 o 3.",
        welcome: "Hola. Eleg√≠ una opci√≥n:",
        opt1: "1) Explorar CONSIA",
        opt2: "2) Hacer algo (ya)",
        opt3: "3) Soporte / Cuenta",
        sent: "Enviado",
        thinking: "Procesando‚Ä¶",
        cant_mic: "No pude acceder al micr√≥fono en este navegador.",
        hyper_info_title: "Hyperrealismo",
        hyper_info_note: "Eleg√≠ qu√© quer√©s ver en Hyperrealismo (avatar, escenas, renders).",
        facetime_info_title: "FaceTime",
        facetime_info_note: "Modo FaceTime (c√°mara + gu√≠a). Listo para activar cuando integremos WebRTC.",
        voice_info_title: "Voz",
        voice_info_note: "Habl√° y CONSIA responde. Tambi√©n puede leer la respuesta en voz alta."
      },
      en: {
        status_ok: "Online",
        status_down: "Offline",
        avatar_line: "Tell me what you want. I‚Äôll handle it.",
        avatar_sub: "Tip: type ‚Äú.‚Äù to trigger instant magic.",
        explore: "Explore",
        do_now: "Do now",
        support: "Support",
        magic_dot: "Magic ‚Äú.‚Äù",
        q1d: "See everything CONSIA can do.",
        q2d: "Plan, summarize, decide, execute.",
        q3d: "Account, billing, issues, help.",
        q4d: "One button. One dot. Done.",
        placeholder: "Tell me what you want. (or type ‚Äú.‚Äù)",
        core_title: "CONSIA ‚Ä¢ CORE",
        modal_voice: "Voice",
        modal_facetime: "FaceTime",
        modal_hyper: "Hyperrealism",
        m_voice: "Voice",
        m_facetime: "FaceTime",
        m_hyper: "Hyperrealism",
        choose_3: "Pick 1, 2 or 3.",
        welcome: "Hi. Pick an option:",
        opt1: "1) Explore CONSIA",
        opt2: "2) Do something (now)",
        opt3: "3) Support / Account",
        sent: "Sent",
        thinking: "Processing‚Ä¶",
        cant_mic: "I couldn‚Äôt access the microphone in this browser.",
        hyper_info_title: "Hyperrealism",
        hyper_info_note: "Choose what you want to see in Hyperrealism (avatar, scenes, renders).",
        facetime_info_title: "FaceTime",
        facetime_info_note: "FaceTime mode (camera + guidance). Ready to enable when we integrate WebRTC.",
        voice_info_title: "Voice",
        voice_info_note: "Speak and CONSIA responds. It can also read the reply out loud."
      },
      pt: {
        status_ok: "Online",
        status_down: "Offline",
        avatar_line: "Diga o que voc√™ quer. Eu cuido disso.",
        avatar_sub: "Dica: digite ‚Äú.‚Äù para ativar a magia instant√¢nea.",
        explore: "Explorar",
        do_now: "Fazer agora",
        support: "Suporte",
        magic_dot: "Magia ‚Äú.‚Äù",
        q1d: "Ver tudo o que a CONSIA pode fazer.",
        q2d: "Planejar, resumir, decidir, executar.",
        q3d: "Conta, pagamentos, erros, ajuda.",
        q4d: "Um bot√£o. Um ponto. Pronto.",
        placeholder: "Diga o que voc√™ quer. (ou digite ‚Äú.‚Äù)",
        core_title: "CONSIA ‚Ä¢ CORE",
        modal_voice: "Voz",
        modal_facetime: "FaceTime",
        modal_hyper: "Hiper-realismo",
        m_voice: "Voz",
        m_facetime: "FaceTime",
        m_hyper: "Hiper-realismo",
        choose_3: "Escolha 1, 2 ou 3.",
        welcome: "Ol√°. Escolha uma op√ß√£o:",
        opt1: "1) Explorar CONSIA",
        opt2: "2) Fazer algo (agora)",
        opt3: "3) Suporte / Conta",
        sent: "Enviado",
        thinking: "Processando‚Ä¶",
        cant_mic: "N√£o consegui acessar o microfone neste navegador.",
        hyper_info_title: "Hiper-realismo",
        hyper_info_note: "Escolha o que voc√™ quer ver em Hiper-realismo (avatar, cenas, renders).",
        facetime_info_title: "FaceTime",
        facetime_info_note: "Modo FaceTime (c√¢mera + guia). Pronto para ativar quando integrarmos WebRTC.",
        voice_info_title: "Voz",
        voice_info_note: "Fale e a CONSIA responde. Tamb√©m pode ler a resposta em voz alta."
      }
    };

    function detectInitialLang(){
      const saved = localStorage.getItem(LS.lang);
      if (saved && I18N[saved]) return saved;
      const nav = (navigator.language || "en").toLowerCase();
      if (nav.startsWith("es")) return "es";
      if (nav.startsWith("pt")) return "pt";
      return "en";
    }

    let LANG = detectInitialLang();
    let MODE = localStorage.getItem(LS.mode) || "chat";

    function t(key){
      return (I18N[LANG] && I18N[LANG][key]) || (I18N.en[key]) || key;
    }

    /* =========================
       SESSION
       ========================= */
    function getSid(){
      let sid = localStorage.getItem(LS.sid);
      if (!sid) {
        sid = cryptoRandomId();
        localStorage.setItem(LS.sid, sid);
      }
      return sid;
    }

    function resetSid(){
      localStorage.removeItem(LS.sid);
      window.location.reload();
    }

    /* =========================
       UI helpers
       ========================= */
    const $ = (id)=>document.getElementById(id);

    const chatBody = $("chatBody");
    const input = $("input");
    const sendBtn = $("sendBtn");
    const magicBtn = $("magicBtn");
    const resetBtn = $("resetBtn");
    const langBtn = $("langBtn");
    const statusText = $("statusText");
    const statusDot = $("statusDot");

    const avatarLine = $("avatarLine");
    const avatarSub = $("avatarSub");
    const avatarState = $("avatarState");
    const liveDot = $("liveDot");

    const speakBtn = $("speakBtn");
    const btnVoice = $("btnVoice");
    const btnFaceTime = $("btnFaceTime");
    const btnHyper = $("btnHyper");

    const modal = $("modal");
    const modalTitle = $("modalTitle");
    const modalNote = $("modalNote");
    const modalSmall = $("modalSmall");
    const modalActions = $("modalActions");
    const closeModal = $("closeModal");

    function setStatus(ok){
      if (ok){
        statusText.textContent = t("status_ok");
        statusDot.style.background = "var(--ok)";
      } else {
        statusText.textContent = t("status_down");
        statusDot.style.background = "var(--err)";
      }
    }

    function addMsg(text, who="consia"){
      const wrap = document.createElement("div");
      wrap.className = "msg" + (who==="me" ? " me" : "");
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      wrap.appendChild(bubble);
      chatBody.appendChild(wrap);
      chatBody.scrollTop = chatBody.scrollHeight;
      return bubble;
    }

    function setMode(mode){
      MODE = mode;
      localStorage.setItem(LS.mode, MODE);
      document.querySelectorAll(".mode").forEach(el=>{
        el.classList.toggle("active", el.dataset.mode === MODE);
      });
      // Avatar copy changes subtly
      if (MODE==="voice") avatarState.textContent = "CONSIA ‚Ä¢ VOZ";
      else if (MODE==="facetime") avatarState.textContent = "CONSIA ‚Ä¢ FACETIME";
      else if (MODE==="hyperrealism") avatarState.textContent = "CONSIA ‚Ä¢ HYPERREAL";
      else avatarState.textContent = "CONSIA ‚Ä¢ ACTIVA";
    }

    function applyLang(){
      localStorage.setItem(LS.lang, LANG);
      $("chatTitle").textContent = t("core_title");
      avatarLine.textContent = t("avatar_line");
      avatarSub.textContent = t("avatar_sub");
      $("q1t").textContent = t("explore");
      $("q2t").textContent = t("do_now");
      $("q3t").textContent = t("support");
      $("q4t").textContent = t("magic_dot");
      $("q1d").textContent = t("q1d");
      $("q2d").textContent = t("q2d");
      $("q3d").textContent = t("q3d");
      $("q4d").textContent = t("q4d");
      input.placeholder = t("placeholder");
      $("mVoice").textContent = t("m_voice");
      $("mFace").textContent = t("m_facetime");
      $("mHyper").textContent = t("m_hyper");
    }

    function openModal(title, note, small="", actions=[]){
      modalTitle.textContent = title;
      modalNote.textContent = note;
      modalSmall.textContent = small;
      modalActions.innerHTML = "";
      actions.forEach(a=>{
        const b = document.createElement("button");
        b.className = a.primary ? "btn primary" : "btn";
        b.textContent = a.label;
        b.onclick = a.onClick;
        modalActions.appendChild(b);
      });
      modal.classList.add("on");
    }

    function closeModalNow(){ modal.classList.remove("on"); }

    /* =========================
       VOICE (SpeechRecognition + TTS)
       ========================= */
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognizer = null;
    let speaking = false;

    function speak(text){
      try{
        if (!text) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = LANG === "pt" ? "pt-BR" : (LANG === "es" ? "es-ES" : "en-US");
        u.rate = 1.0; u.pitch = 1.0;
        speaking = true;
        u.onend = ()=>{ speaking=false; };
        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    async function startVoiceCapture(){
      if (!SpeechRecognition) {
        openModal(t("modal_voice"), t("cant_mic"));
        return;
      }
      recognizer = new SpeechRecognition();
      recognizer.lang = LANG === "pt" ? "pt-BR" : (LANG === "es" ? "es-ES" : "en-US");
      recognizer.interimResults = false;
      recognizer.maxAlternatives = 1;

      openModal(t("modal_voice"), t("voice_info_note"), "", [
        { label: "OK", primary:true, onClick: closeModalNow }
      ]);

      recognizer.onresult = (ev)=>{
        const text = ev.results?.[0]?.[0]?.transcript || "";
        if (text.trim()) {
          input.value = text.trim();
          autoresize();
          send();
        }
      };
      recognizer.onerror = ()=>{};
      recognizer.start();
    }

    /* =========================
       API CALL
       ========================= */
    async function callAsk(message){
      const sid = getSid();
      const payload = { message, mode: MODE, hint: "" };

      const res = await fetch(API_URL, {
        method:"POST",
        headers:{
          "content-type":"application/json",
          "accept-language": LANG,
          "x-consia-session": sid
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=> ({}));
      return { ok: res.ok, status: res.status, data };
    }

    async function health(){
      try{
        const r = await fetch(HEALTH_URL, { headers:{ "accept-language": LANG }});
        setStatus(r.ok);
      }catch(e){
        setStatus(false);
      }
    }

    /* =========================
       ‚ÄúMAGIA‚Äù: Home guidance
       ========================= */
    function magic(){
      addMsg(".", "me");
      sendMessage(".");
    }

    /* =========================
       SEND
       ========================= */
    async function send(){
      const text = (input.value || "").trim();
      if (!text) return;
      input.value = "";
      autoresize();
      addMsg(text, "me");
      await sendMessage(text);
    }

    async function sendMessage(text){
      // UI ‚Äúalive‚Äù
      liveDot.style.background = "var(--warn)";
      liveDot.style.boxShadow = "0 0 18px rgba(255,210,106,.35)";
      const thinking = addMsg(t("thinking"), "consia");

      try{
        const out = await callAsk(text);
        if (!out.ok) {
          thinking.textContent = "Error ("+out.status+").";
        } else {
          const ans = out.data?.answer || "";
          thinking.textContent = ans || "(ok)";
          // Optional UI quick actions
          const quick = out.data?.ui?.quick;
          if (Array.isArray(quick) && quick.length){
            thinking.textContent += "\n";
            thinking.textContent += quick.map(q=> `‚Ä¢ ${q.id}) ${q.label}`).join("\n");
          }
          // Auto-speak in voice mode
          if (MODE === "voice") speak(ans);
        }
      }catch(e){
        thinking.textContent = "Error.";
      }finally{
        liveDot.style.background = "var(--ok)";
        liveDot.style.boxShadow = "0 0 18px rgba(71,230,160,.35)";
      }
    }

    /* =========================
       One-button guidance cards
       ========================= */
    function quickPick(val){
      if (val === ".") return magic();
      input.value = String(val);
      autoresize();
      send();
    }

    /* =========================
       TEXTAREA auto-resize
       ========================= */
    function autoresize(){
      input.style.height = "auto";
      input.style.height = Math.min(input.scrollHeight, 120) + "px";
    }

    /* =========================
       INIT
       ========================= */
    function cryptoRandomId(){
      const a = new Uint8Array(16);
      crypto.getRandomValues(a);
      return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    function cycleLang(){
      LANG = (LANG === "es") ? "en" : (LANG === "en") ? "pt" : "es";
      applyLang();
      // refresh a ‚Äúhome‚Äù guidance to match language
      addMsg(t("welcome")+"\n"+t("opt1")+"\n"+t("opt2")+"\n"+t("opt3"), "consia");
    }

    function initModes(){
      document.querySelectorAll(".mode").forEach(el=>{
        el.onclick = ()=>{
          setMode(el.dataset.mode);
          if (MODE==="voice"){
            openModal(t("modal_voice"), t("voice_info_note"), "", [
              {label:"Iniciar", primary:true, onClick: ()=>{ closeModalNow(); startVoiceCapture(); }},
              {label:"Cerrar", onClick: closeModalNow}
            ]);
          }
          if (MODE==="facetime"){
            openModal(t("modal_facetime"), t("facetime_info_note"), "", [
              {label:"OK", primary:true, onClick: closeModalNow}
            ]);
          }
          if (MODE==="hyperrealism"){
            openModal(t("modal_hyper"), t("hyper_info_note"), "", [
              {label:"Avatar hiperrealista", primary:true, onClick: ()=>{ closeModalNow(); quickPick("3"); }},
              {label:"Escena / Render", onClick: ()=>{ closeModalNow(); input.value="Quiero hyperrealismo: "; input.focus(); autoresize(); }},
              {label:"Cerrar", onClick: closeModalNow}
            ]);
          }
        };
      });
    }

    function initQuickCards(){
      document.querySelectorAll(".qcard").forEach(el=>{
        el.onclick = ()=> quickPick(el.dataset.q);
      });
    }

    function initButtons(){
      sendBtn.onclick = send;
      magicBtn.onclick = magic;
      resetBtn.onclick = resetSid;
      langBtn.onclick = cycleLang;

      closeModal.onclick = closeModalNow;
      modal.onclick = (e)=>{ if (e.target === modal) closeModalNow(); };

      speakBtn.onclick = ()=>{
        const last = [...chatBody.querySelectorAll(".msg:not(.me) .bubble")].pop();
        if (last) speak(last.textContent || "");
      };

      btnVoice.onclick = ()=>{ setMode("voice"); startVoiceCapture(); };
      btnFaceTime.onclick = ()=>{ setMode("facetime"); openModal(t("modal_facetime"), t("facetime_info_note"), "", [{label:"OK", primary:true, onClick: closeModalNow}]); };
      btnHyper.onclick = ()=>{ setMode("hyperrealism"); openModal(t("modal_hyper"), t("hyper_info_note"), "", [{label:"OK", primary:true, onClick: closeModalNow}]); };

      input.addEventListener("keydown", (e)=>{
        if (e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          send();
        }
      });
      input.addEventListener("input", autoresize);
    }

    async function boot(){
      applyLang();
      setMode(MODE);
      initModes();
      initQuickCards();
      initButtons();
      autoresize();
      await health();

      // First message: ultra-guided, 3 options
      addMsg(t("welcome")+"\n"+t("opt1")+"\n"+t("opt2")+"\n"+t("opt3")+"\n\n"+t("choose_3"), "consia");
    }

    boot();
  </script>
</body>
</html>
