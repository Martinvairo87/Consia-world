<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CONSIA Voice Core</title>

<script src="https://cdn.jsdelivr.net/npm/@picovoice/porcupine-web@1.2.0/dist/iife/index.js"></script>

<style>
body{
  margin:0;
  background:black;
  font-family:Arial,Helvetica,sans-serif;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  flex-direction:column;
}

#orb{
  width:220px;
  height:220px;
  border-radius:50%;
  background:radial-gradient(circle,#00f0ff,#001aff,#000);
  box-shadow:0 0 80px #00f0ff;
  animation:pulse 2s infinite;
}

@keyframes pulse{
  0%{transform:scale(1);}
  50%{transform:scale(1.08);}
  100%{transform:scale(1);}
}

button{
  margin-top:40px;
  padding:15px 40px;
  border:none;
  border-radius:40px;
  background:#00f0ff;
  color:black;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="orb"></div>
<button onclick="startConsia()">ACTIVAR CONSIA</button>

<script>
let porcupine = null;
let audioContext = null;
let mediaStream = null;

async function startConsia(){

  alert("CONSIA escuchando...");

  audioContext = new AudioContext();

  mediaStream = await navigator.mediaDevices.getUserMedia({
    audio:true
  });

  const accessKey = 9+cUNbpO4ENSiqX0sPEMphHDjK3cRgd9oWJwMnzSJ8l9o0R/x8k82Q==;

  porcupine = await PorcupineWeb.PorcupineWorker.create(
    accessKey,
    [{
      builtin:"Computer", // wake provisional
      sensitivity:0.7
    }],
    wakeWordDetected
  );

  const source =
    audioContext.createMediaStreamSource(mediaStream);

  const processor =
    audioContext.createScriptProcessor(512,1,1);

  source.connect(processor);
  processor.connect(audioContext.destination);

  processor.onaudioprocess = function(e){
    const input = e.inputBuffer.getChannelData(0);
    porcupine.process(input);
  };
}

function wakeWordDetected(){

  console.log("WAKE WORD DETECTED");

  document.getElementById("orb").style.boxShadow =
    "0 0 120px #00ff88";

  startStreaming();
}

async function startStreaming(){

  const stream =
    await navigator.mediaDevices.getUserMedia({audio:true});

  const mediaRecorder =
    new MediaRecorder(stream);

  mediaRecorder.start(1000);

  mediaRecorder.ondataavailable = async e => {

    const blob = e.data;

    const form = new FormData();
    form.append("audio",blob);

    await fetch(
      "https://api.consia.world/voice",
      {
        method:"POST",
        body:form
      }
    );
  };
}
</script>

</body>
</html>
