<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#000000"/>
  <title>CONSIA Voice</title>
  <style>
    :root { color-scheme: dark; }
    html,body { height:100%; margin:0; background:#000; color:#fff; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; }
    .wrap { min-height:100%; display:flex; align-items:center; justify-content:center; padding:18px; box-sizing:border-box; }
    .card { width:min(980px, 98vw); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:18px; background:rgba(255,255,255,.04); }
    .top { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .title { letter-spacing:.18em; text-transform:uppercase; font-weight:800; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button, input, textarea { background:rgba(0,0,0,.4); color:#fff; border:1px solid rgba(255,255,255,.16); border-radius:12px; padding:12px 12px; font-size:15px; }
    button { cursor:pointer; font-weight:700; }
    button:hover { border-color:rgba(255,255,255,.34); background:rgba(255,255,255,.06); }
    textarea { width:100%; min-height:92px; resize:vertical; }
    .log { white-space:pre-wrap; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:12px; min-height:140px; }
    .pill { font-size:12px; opacity:.85; border:1px solid rgba(255,255,255,.14); border-radius:999px; padding:8px 10px; }
    .ok { color:#9cff9c; } .bad{ color:#ff9c9c; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div class="title">CONSIA Voice / Avatar</div>
      <div class="row" style="margin-top:0">
        <span class="pill">Mic: <span id="mic">idle</span></span>
        <span class="pill">API: <span id="api">checking‚Ä¶</span></span>
        <a class="pill" href="/" style="text-decoration:none;color:#fff;">‚Üê Home</a>
      </div>
    </div>

    <div class="row">
      <button id="btnMic">üéôÔ∏è Hablar</button>
      <button id="btnStop" disabled>‚èπÔ∏è Stop</button>
      <button id="btnSend">‚û°Ô∏è Enviar texto</button>
    </div>

    <div class="row">
      <textarea id="msg" placeholder="Escrib√≠ ac√° o toc√° Hablar."></textarea>
    </div>

    <div class="row">
      <div style="flex:1;min-width:280px;">
        <div class="pill">Respuesta</div>
        <div id="out" class="log"></div>
      </div>
      <div style="flex:1;min-width:280px;">
        <div class="pill">Speech (TTS)</div>
        <div class="log" id="ttslog">Listo. Cuando llegue respuesta, la leo con voz del dispositivo (TTS local).</div>
      </div>
    </div>
  </div>
</div>

<script>
  const API = "https://api.consia.world";

  // health
  (async()=>{
    const el = document.getElementById("api");
    try{
      const r = await fetch(API+"/health");
      const j = await r.json().catch(()=>null);
      if(r.ok && j && j.ok){ el.textContent="healthy"; el.className="ok"; }
      else { el.textContent="degraded"; el.className="bad"; }
    }catch{ el.textContent="offline"; el.className="bad"; }
  })();

  // STT (Web Speech API) -> texto -> /ask
  const micEl = document.getElementById("mic");
  const btnMic = document.getElementById("btnMic");
  const btnStop = document.getElementById("btnStop");
  const btnSend = document.getElementById("btnSend");
  const msg = document.getElementById("msg");
  const out = document.getElementById("out");
  const ttslog = document.getElementById("ttslog");

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;

  function speakLocal(text){
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-ES";
      speechSynthesis.speak(u);
      ttslog.textContent = "Hablando: " + text;
    }catch{
      ttslog.textContent = "TTS no disponible en este navegador.";
    }
  }

  async function askConsia(text){
    out.textContent = "Enviando a CONSIA‚Ä¶";
    const r = await fetch(API + "/ask", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message: text })
    });
    const j = await r.json().catch(()=>({ ok:false, error:"bad_json" }));
    out.textContent = JSON.stringify(j, null, 2);

    // si viene "response" lo leo
    if (j && j.response) speakLocal(String(j.response));
  }

  btnSend.onclick = async () => {
    const text = (msg.value || "").trim();
    if(!text) return;
    await askConsia(text);
  };

  btnMic.onclick = () => {
    if(!SpeechRecognition){
      micEl.textContent = "not_supported";
      micEl.className = "bad";
      return;
    }
    rec = new SpeechRecognition();
    rec.lang = "es-ES";
    rec.interimResults = true;
    rec.continuous = true;

    let finalText = "";
    rec.onstart = () => { micEl.textContent = "listening"; micEl.className="ok"; btnStop.disabled=false; };
    rec.onend = () => { micEl.textContent = "idle"; micEl.className=""; btnStop.disabled=true; };

    rec.onresult = (e) => {
      let interim = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) finalText += t + " ";
        else interim += t;
      }
      msg.value = (finalText + interim).trim();
    };

    rec.start();
  };

  btnStop.onclick = async () => {
    try { rec && rec.stop(); } catch {}
    const text = (msg.value || "").trim();
    if(text) await askConsia(text);
  };
</script>
</body>
</html>
